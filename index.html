<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=no, viewport-fit=cover">
    <meta property="og:title" content="UFO MOBILE" />
    <meta property="og:description"
        content="Antyalkoholowa gra promujƒÖca trze≈∫wy spos√≥b ≈ºycia. Pos≈Çuchaj rad kosmit√≥w." />
    <meta property="og:image" content="logo.webp" />
    <meta property="og:url" content="https://humbag738.github.io/ufo.mobile/" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="UFO MOBILE" />
    <meta name="twitter:card" content="logo.webp" />
    <meta name="twitter:title" content="UFO MOBILE" />
    <meta name="twitter:description"
        content="Antyalkoholowa gra promujƒÖca trze≈∫wy spos√≥b ≈ºycia. Pos≈Çuchaj rad kosmit√≥w." />
    <meta name="twitter:image" content="logo.webp" />
    <meta name="twitter:url" content="https://humbag738.github.io/ufo.mobile/" />
    <title>UFO MOBILE</title>
    <link rel="icon" sizes="16x16 32x32 48x48" type="image/png" href="ikona.png" />
    <style>
        :root {
            --accent: #c084fc;
            --bg: #0f0a1e;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: white;
            font-family: 'Pixel Sans Medium', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            height: -webkit-fill-available;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 4 / 3;
            background: #000;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border: 2px solid var(--accent);
            border-radius: 8px;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
            image-rendering: pixelated;
        }

        .ui-overlay {
            position: absolute;
            top: 7.5px;
            left: 7.5px;
            right: 7.5px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.5s;
        }

        body.playing .ui-overlay {
            opacity: 1;
        }

        .stats-group {
            display: flex;
            gap: 5px;
            background: rgba(0, 0, 0, 0.6);
            padding: 2px 5px;
            border-radius: 4px;
            border: 1px solid var(--accent);
        }

        .stat-item {
            color: white;
            font-size: 0.55rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 4px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .stat-icon {
            width: 9px;
            height: 9px;
            object-fit: contain;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            width: 100%;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
            z-index: 300;
        }

        .control-btn {
            width: 76px;
            /* Zmniejszone o 10% z 85px */
            height: 76px;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            transition: transform 0.1s;
            touch-action: none;
            /* Blokuje gesty systemowe na przyciskach */
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        .control-btn:active {
            transform: scale(0.9);
        }

        .control-icon {
            width: 60px;
            height: 60px;
            object-fit: contain;
            pointer-events: none;
        }

        .d-pad {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .d-pad-row {
            display: flex;
            gap: 10px;
        }

        .action-btns {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }


        #menu,
        #gameover,
        #level-complete {
            position: absolute;
            inset: 0;
            background-color: #0f0a1e;
            background-position: center center;
            background-repeat: no-repeat;
            background-size: contain;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px 20px;
            z-index: 100;
            overflow-y: auto;
            font-family: 'Pixel Sans Medium', sans-serif !important;
        }

        #menu {
            background-image: url('logo.webp');
        }

        #gameover {
            background-image: url('logo2.webp');
        }

        #level-complete {
            background-image: url('logo2.webp');
        }

        /* Usuniƒôto przyciemnienie i blur na ≈ºyczenie u≈ºytkownika */

        .modal-content {
            max-width: 400px;
        }

        h1 {
            font-size: 2.5rem;
            margin: 0 0 10px;
            color: var(--accent);
            text-transform: uppercase;
            font-family: 'Pixel Sans Medium', sans-serif !important;
        }

        button.start-btn {
            background: url('ramka.webp') no-repeat center center;
            background-size: 100% 100%;
            color: transparent;
            /* Ukrycie tekstu tekstowego */
            border: none;
            padding: 25px 60px;
            font-size: 0;
            /* Rozmiar czcionki 0, aby tekst nie zajmowa≈Ç miejsca */
            cursor: pointer;
            margin-top: 150px;
            /* Obni≈ºenie przycisku */
            transition: transform 0.2s;
            min-width: 250px;
            /* Dopasowanie szeroko≈õci do grafiki ramka.webp */
            min-height: 80px;
            /* Dopasowanie wysoko≈õci */
        }

        button.start-btn:active {
            transform: scale(0.95);
        }

        /* Usuniƒôto layout-selector z CSS, teraz jest inline lub w #controls-settings */
        .controls-settings {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            transition: opacity 0.5s;
        }

        .controls-settings.hidden {
            display: none;
            opacity: 0;
            pointer-events: none;
        }

        .layout-options {
            display: flex;
            gap: 20px;
        }

        .layout-btn-img {
            background: transparent;
            border: 3px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: all 0.2s;
            max-height: 60px;
            object-fit: contain;
        }

        .layout-btn-img:hover {
            transform: scale(1.05);
            opacity: 0.8;
        }

        .layout-btn-img.active {
            border-color: var(--accent);
            opacity: 1;
            box-shadow: 0 0 15px var(--accent);
        }

        .hidden {
            display: none !important;
        }

        /* Ukryj kontrolki na urzƒÖdzeniach z precyzyjnym wska≈∫nikiem (mysz / laptop) */
        @media (hover: hover) and (pointer: fine) {

            .controls,
            #controls-settings {
                display: none !important;
            }
        }

        /* Wymu≈õ widoczno≈õƒá na typowych urzƒÖdzeniach dotykowych */
        @media (hover: none) and (pointer: coarse) {
            .controls {
                display: flex !important;
            }

            #controls-settings {
                display: flex !important;
            }
        }
    </style>
</head>

<body>

    <div id="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <div class="ui-overlay">
            <div class="stats-group">
                <div class="stat-item">
                    <img src="kosmita.webp" class="stat-icon" alt="üëΩ">
                    <span id="coins-ui">0 / 28</span>
                </div>
                <div class="stat-item">
                    <img src="serce.webp" class="stat-icon" alt="‚ù§Ô∏è">
                    <span id="lives-ui">20</span>
                </div>
            </div>
            <div class="stats-group">
                <div class="stat-item">
                    <img src="strzalka.png" class="stat-icon" alt="üöÄ">
                    <span id="level-ui">1</span>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="menu">
            <div class="modal-content">
                <h1 style="display: none;"></h1>

                <button class="start-btn" onclick="startGame()"
                    style="margin-bottom: 30px; display: none;">≈ÅADOWANIE...</button>
            </div>
        </div>

        <div id="gameover" class="hidden">
            <div class="modal-content">
                <img src="gameover.webp" alt="GAME OVER" style="max-width: 250px; margin-bottom: 10px;">
                <button class="start-btn" onclick="startGame()"></button>
            </div>
        </div>

        <div id="level-complete" class="hidden">
            <div class="modal-content">
                <img src="przeszedles.webp" alt="PRZESZED≈ÅE≈ö!" style="max-width: 100%; margin-bottom: 20px;">
                <div style="display: flex; justify-content: center; width: 100%;">
                    <button class="start-btn" onclick="nextLevel()"
                        style="font-size: 0; padding: 25px 60px; margin-top: 10px;"></button>
                </div>
            </div>
        </div>

        <div id="final-screen" class="hidden"
            style="position: absolute; inset: 0; background: #1a1a2e; z-index: 200; flex-direction: column; justify-content: center; align-items: center;">
            <canvas id="finalCanvas" width="800" height="600" style="position: absolute;"></canvas>
            <div
                style="z-index: 210; text-align: center; display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                <h1 style="color: #4ade80; font-size: 2.2rem; text-shadow: 2px 2px 4px #000; margin: 0;">GRATULACJE!
                </h1>
                <h2 style="color: white; font-size: 1.5rem; text-shadow: 2px 2px 4px #000; margin: 0;">PRZESZED≈ÅE≈ö GRƒò!
                </h2>
                <p style="color: #ccc; font-size: 1.0rem; text-shadow: 1px 1px 2px #000; margin: 0;">CZ≈ÅOWIEK ZOSTA≈Å
                    URATOWANY!</p>
                <button class="start-btn" onclick="location.reload()"
                    style="font-size: 1rem; padding: 10px 20px; margin-top: 10px;">ZAGRAJ PONOWNIE</button>
            </div>
        </div>
    </div>


    <div class="controls">
        <div class="d-pad">
            <div class="control-btn" id="btn-jump-mobile" style="width: 50px; height: 50px; visibility: hidden;"></div>
            <!-- Spacer -->
            <div class="d-pad-row">
                <div class="control-btn" id="btn-left">
                    <img src="left.png" class="control-icon">
                </div>
                <div class="control-btn" id="btn-down">
                    <img src="down.png" class="control-icon">
                </div>
                <div class="control-btn" id="btn-right">
                    <img src="right.png" class="control-icon">
                </div>
            </div>
        </div>
        <div class="action-btns">
            <div class="control-btn" id="btn-shoot">
                <img src="fire.png" class="control-icon">
            </div>
            <div class="control-btn" id="btn-jump">
                <img src="up.png" class="control-icon">
            </div>
        </div>
    </div>

    <div id="controls-settings" class="controls-settings">
        <img src="sterowanie.png" alt="STEROWANIE" style="height: 70px; margin-bottom: 5px;">
        <div class="layout-options">
            <img src="domyslne.png" class="layout-btn-img active" onclick="setControlLayout('default')" alt="Domy≈õlne">
            <img src="strzalki.png" class="layout-btn-img" onclick="setControlLayout('keyboard')" alt="Strza≈Çki">
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Game Constants
        const GAME_WIDTH = 800;
        const GAME_HEIGHT = 600;
        const GRAVITY = 0.6;
        const JUMP_FORCE = -14;
        const MOVE_SPEED = 4.5;
        const COINS_TO_WIN = 28;
        const MAX_LIVES = 20;

        // Simple SFX Pools (Works on local files without CORS issues)
        const sfxPools = {};
        function preloadSFX(name, url, count = 5) {
            sfxPools[name] = {
                instances: Array.from({ length: count }, () => {
                    const a = new Audio(url);
                    a.volume = 1; // Lower volume to reduce OS ducking effect
                    a.preload = 'auto';
                    return a;
                }),
                index: 0
            };
        }

        preloadSFX('skok', 'skok.opus', 5);
        preloadSFX('coin', 'coin.opus', 8);
        preloadSFX('shot', 'shot.opus', 5);
        preloadSFX('shot_enemy', 'shot_enemy.opus', 5);
        preloadSFX('przycisk', 'przycisk.opus', 3);
        preloadSFX('spodek', 'spodek.opus', 1);
        preloadSFX('cios', 'cios.mp3', 5);

        function playSFX(name) {
            if (!sfxPools[name]) return;
            const pool = sfxPools[name];
            const instance = pool.instances[pool.index];
            instance.currentTime = 0;
            instance.play().catch(() => { });
            pool.index = (pool.index + 1) % pool.instances.length;
        }

        const sfxUfo = 'spodek';
        const sfxJump = 'skok';
        const sfxShot = 'shot';
        const sfxShotEnemy = 'shot_enemy';
        const sfxButton = 'przycisk';
        const sfxCoin = 'coin';

        const bgMusic = new Audio('muzyka.opus');
        bgMusic.loop = true;
        bgMusic.volume = 1;

        const bgMusicBoss = new Audio('muzyka_boss.opus');
        bgMusicBoss.loop = true;
        bgMusicBoss.volume = 1;

        const bgMusicEnding = new Audio('ending.opus');
        bgMusicEnding.loop = true;
        bgMusicEnding.volume = 1;

        const bgMusicKarczma = new Audio('karczmarz_audio.mp3');
        bgMusicKarczma.loop = true;
        bgMusicKarczma.volume = 0.8;

        const sfxKlepsydra = new Audio('klepsydra.mp3');
        sfxKlepsydra.volume = 1;

        let musicStarted = false;

        function startMusic() {
            if (!musicStarted) {
                // Hide settings if they are still visible (e.g. clicking body to start music)
                // Actually startMusic is bound to click/touch once.
                // It's safer to not hide settings here, but only in startGame.
                if (level === 7) {
                    bgMusicBoss.play().then(() => musicStarted = true).catch(e => console.log(e));
                } else if (level === 6) {
                    bgMusicKarczma.play().then(() => musicStarted = true).catch(e => console.log(e));
                } else {
                    bgMusic.play().then(() => musicStarted = true).catch(e => console.log(e));
                }
            }
        }

        // Dodanie globalnego nas≈Çuchiwacza dla startu muzyki na ekranie startowym
        window.addEventListener('click', startMusic, { once: true });
        window.addEventListener('touchstart', startMusic, { once: true });

        const COLOR_SCHEMES = [
            { bg: '#0f0a1e', platforms: '#6b21a8', accent: '#c084fc', ground: '#4c1d95', stars: '#e9d5ff' }, // Level 1 (Fiolet)
            { bg: '#0a1e14', platforms: '#166534', accent: '#4ade80', ground: '#15803d', stars: '#bbf7d0' }, // Level 2 (Ziele≈Ñ)
            { bg: '#1e0f0a', platforms: '#c2410c', accent: '#fb923c', ground: '#9a3412', stars: '#fed7aa' }, // Level 3 (Pomara≈Ñcz)
            { bg: '#0a141e', platforms: '#1e40af', accent: '#60a5fa', ground: '#1e3a8a', stars: '#bfdbfe' }, // Level 4 (B≈Çƒôkit)
            { bg: '#050314', platforms: '#7e22ce', accent: '#d8b4fe', ground: '#581c87', stars: '#f3e8ff' }, // Level 5 (Near Black)
            { bg: '#a3e635', platforms: '#1e40af', accent: '#60a5fa', ground: '#1e3a8a', stars: '#dbeafe' }, // Level 6 (Light Green)
            { bg: '#1e0a0a', platforms: '#7f1d1d', accent: '#ef4444', ground: '#450a0a', stars: '#fecaca' }, // Level 7 (Czerwie≈Ñ - Boss)
        ];

        // Assets Loader
        const assets = {
            images: {},
            total: 0,
            loaded: 0,
            isReady: false
        };

        function loadImage(name, src) {
            assets.total++;
            const img = new Image();
            img.onload = () => {
                assets.loaded++;
                checkAssetsLoaded();
            };
            img.onerror = () => {
                console.error(`B≈ÇƒÖd ≈Çadowania: ${src}`);
                assets.loaded++;
                checkAssetsLoaded();
            };
            img.src = src;
            assets.images[name] = img;
            return img;
        }

        function checkAssetsLoaded() {
            const btn = document.querySelector('.start-btn');
            const progress = assets.total > 0 ? (assets.loaded / assets.total) : 0;

            // Draw loading bar on canvas
            if (!assets.isReady) {
                ctx.fillStyle = '#0f0a1e';
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

                const barWidth = 400;
                const barHeight = 30;
                const x = (GAME_WIDTH - barWidth) / 2;
                const y = (GAME_HEIGHT - barHeight) / 2 + 50;

                // Border
                ctx.strokeStyle = '#c084fc';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, barWidth, barHeight);

                // Fill
                ctx.fillStyle = '#c084fc';
                ctx.fillRect(x + 4, y + 4, (barWidth - 8) * progress, barHeight - 8);

                // Text
                ctx.fillStyle = 'white';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`≈ÅADOWANIE: ${Math.round(progress * 100)}%`, GAME_WIDTH / 2, y - 20);

                // Logo placeholder or text if needed
                ctx.font = 'bold 40px Arial';
                ctx.fillText('UFO MOBILE', GAME_WIDTH / 2, y - 80);
            }

            if (assets.loaded >= assets.total) {
                assets.isReady = true;
                if (btn) {
                    btn.style.display = 'block'; // Show button when ready
                    btn.innerText = 'GRAJ!';
                    btn.style.color = 'transparent';
                    btn.style.opacity = '1';
                    btn.style.pointerEvents = 'auto';
                }
            } else {
                if (btn) {
                    btn.style.display = 'none'; // Hide button during loading
                    btn.innerText = '≈ÅADOWANIE...';
                    btn.style.color = 'white';
                    btn.style.opacity = '0.7';
                    btn.style.pointerEvents = 'none';
                    btn.style.fontSize = '20px';
                }
            }
        }

        // Preload Images
        const imgTlo = [];
        for (let i = 1; i <= 4; i++) imgTlo.push(loadImage(`tlo_${i}`, `tlo_${i}.webp`));
        imgTlo.push(loadImage('tlo_5', 'tlo_5.png')); // Level 5
        imgTlo.push(loadImage('tlo_6', 'tlo_6.png')); // Level 6
        imgTlo.push(loadImage('tlo_7', 'tlo_7.webp')); // Level 7 (Boss, ex-level 5)

        const imgPodlogiLevel = [];
        for (let i = 1; i <= 4; i++) imgPodlogiLevel[i] = loadImage(`podloga_${i}`, `podloga_${i}.webp`);
        imgPodlogiLevel[5] = loadImage('podloga_5', 'podloga_5.png');
        imgPodlogiLevel[6] = loadImage('podloga_6', 'podloga_6.png');

        const imgBelka = { complete: true }; // Sk≈Çadnik wirtualny, u≈ºywamy pod≈Ç√≥g
        const imgBelkaBoss = loadImage('belka_boss', 'belka_boss.webp');
        const imgPiwo = loadImage('piwo', 'piwo.webp');
        const imgPiwoRed = loadImage('piwo_red', 'piwo_red.webp');
        const imgPodloga = { complete: true }; // Sk≈Çadnik wirtualny
        const imgPodlogaBoss = loadImage('podloga_boss', 'podloga_boss.webp');
        const imgUfo = loadImage('ufo', 'ufo.webp');
        const imgBohater = loadImage('bohater', 'bohater.webp');
        const imgKosmita = loadImage('kosmita', 'kosmita.webp');
        const imgTarczaZielona = loadImage('tarcza_zielona', 'tarcza_zielona.png');
        const imgTarczaNiebieska = loadImage('tarcza_niebieska', 'tarcza_niebieska.png');
        const imgPiwoStrzela = loadImage('piwo_strzela', 'piwo_strzela.webp');
        const imgPiwoFaint = loadImage('piwo_faint', 'piwo_faint.webp');
        const imgBoss = loadImage('boss', 'boss.webp');
        const imgDetoks = loadImage('detoks', 'detoks.png');
        const imgZbierz = loadImage('zbierz', 'zbierz.webp');
        const imgStrzelaj = loadImage('strzelaj', 'strzelaj.webp');
        const imgAlkoholNie = loadImage('alkohol_nie', 'alkohol_nie.webp');
        const imgAlkoholSzkodzi = loadImage('alkohol_szkodzi', 'alkohol_szkodzi.webp');
        const imgBossInfo = loadImage('boss_info', 'boss_info.webp');
        const imgInfo5 = loadImage('info_5', 'info_5.png'); // Level 5 Info
        const imgKarczma = loadImage('karczma', 'karczma.png'); // Level 6 Info
        const imgKarczmarz = loadImage('karczmarz', 'karczmarz.png'); // Level 6 Boss
        const imgKarczmarz1 = loadImage('karczmarz_1', 'karczmarz_1.png');
        const imgKarczmarz2 = loadImage('karczmarz_2', 'karczmarz_2.png');
        const imgKarczmarz3 = loadImage('karczmarz_3', 'karczmarz_3.png');
        const imgKarczmarz4 = loadImage('karczmarz_4', 'karczmarz_4.png');
        const imgCiosany = loadImage('ciosany', 'ciosany.png');
        const imgChmielus = loadImage('chmielus', 'chmielus.png'); // Boss Level Intro
        const imgImieChmielus = loadImage('imie_chmielus', 'imie_chmielus.png');
        const imgNiePij = loadImage('nie_pij', 'nie_pij.png');
        const imgBieg1 = loadImage('bieg_1', 'bieg_1.png');
        const imgBieg2 = loadImage('bieg_2', 'bieg_2.png');
        const imgBieg3 = loadImage('bieg_3', 'bieg_3.png');
        const imgBohater1 = loadImage('bohater_1', 'bohater_1.png');
        const imgBohater2 = loadImage('bohater_2', 'bohater_2.png');
        const imgPancerzZielony = loadImage('pancerz_zielony', 'pancerz_zielony.webp');
        const imgPancerzNiebieski = loadImage('pancerz_niebieski', 'pancerz_niebieski.webp');
        const imgPancerzCzerwony = loadImage('pancerz_czerwony', 'pancerz_czerwony.webp');
        const imgTrzezwosc = loadImage('trzezwosc', 'trzezwosc.webp');
        const imgEndTitle = { complete: true }; // Brak pliku
        const imgSzarak = { complete: true }; // Brak pliku
        const imgPlomien = loadImage('plomien', 'plomien.webp');
        const imgPlansza = loadImage('plansza', 'plansza.png');
        const imgPrzyciskStrzelania = loadImage('przycisk_strzelania', 'przycisk_strzelania.webp');
        const imgOni = loadImage('oni', 'oni.webp');
        const imgOstatniaScena = loadImage('ostatnia_scena', 'ostatnia_scena.webp');
        const imgPancerzPeka1 = loadImage('pancerz_peka1', 'pancerz_peka1.webp');
        const imgPancerzPeka2 = loadImage('pancerz_peka2', 'pancerz_peka2.webp');
        const imgPancerzPeka3 = loadImage('pancerz_peka3', 'pancerz_peka3.webp');
        const imgPancerzPeka4 = loadImage('pancerz_peka4', 'pancerz_peka4.webp');
        const imgDialog1 = loadImage('dialog1', 'dialog1.png');
        const imgDialog2 = loadImage('dialog2', 'dialog2.png');
        const imgDialog3 = loadImage('dialog3', 'dialog3.png');
        const imgDialog4 = loadImage('dialog4', 'dialog4.png');
        const imgAniol = loadImage('aniol', 'aniol.webp');
        const imgAniol2 = loadImage('aniol2', 'aniol2.webp');
        const imgDziekuje = loadImage('dziekuje', 'dziekuje.png');
        const imgGrajPonownie = loadImage('grajponownie', 'grajponownie.webp');
        const imgWyjscie = loadImage('wyjscie', 'wyjscie.webp');
        const imgWPrawo = loadImage('w_prawo', 'w_prawo.webp');
        const imgPokonanie = loadImage('pokonanie', 'pokonanie.png');
        const imgKlepsydra = loadImage('klepsydra', 'klepsydra.png');
        const imgLaser = loadImage('laser', 'laser.png');

        checkAssetsLoaded(); // Initial check
        const sfxTrzezwosc = new Audio('dzwiek_trzezwosci.opus'); sfxTrzezwosc.volume = 1;
        const sfxDrzwi = new Audio('drzwi.opus');
        const sfxPrzycisk = new Audio('przycisk.opus');
        const sfxLaser = new Audio('laser.mp3'); sfxLaser.volume = 1;
        const sfxPowerUp = new Audio('power_up.mp3'); sfxPowerUp.volume = 1;

        // Performance Optimization: Offscreen Canvas for Background and Stars
        const bgBufferCanvas = document.createElement('canvas');
        bgBufferCanvas.width = GAME_WIDTH;
        bgBufferCanvas.height = GAME_HEIGHT;
        const bgBufferCtx = bgBufferCanvas.getContext('2d');

        function preRenderBackground() {
            const scheme = COLOR_SCHEMES[(level - 1) % COLOR_SCHEMES.length];

            // Draw Background Image or Solid Color
            if (currentLevelTlo && currentLevelTlo instanceof HTMLImageElement && currentLevelTlo.complete) {
                bgBufferCtx.drawImage(currentLevelTlo, 0, 0);
            } else {
                bgBufferCtx.fillStyle = scheme.bg;
                bgBufferCtx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            }

            // Stars removed as requested
        }

        const starsCanvas = document.createElement('canvas'); // Deprecated

        // Game State
        let gameState = 'menu';
        let level = 1;
        let score = 0;
        let totalScore = 0;
        let coinsCollected = 0;
        let lives = MAX_LIVES;
        let showCelebration = false;
        let abductionPhase = 0;
        let playerAbductX = 0;
        let playerAbductY = 0;
        let playerAbductStartTime = 0;

        let player = { x: 50, y: 500, vx: 0, vy: 0, width: 70, height: 70, onGround: false, facingRight: true, lastShootTime: 0, shieldLevel: 0, isSober: false, invincibilityTimer: 0 };
        let currentLevelTlo, currentLevelPodloga, currentLevelBelka;
        let platforms = [];
        let coins = [];
        let enemies = [];
        let items = [];
        let bullets = [];
        let playerBullets = [];
        let effects = [];
        let boss = null;
        let keys = { left: false, right: false, jump: false, shoot: false, down: false };
        let ufo = { visible: false, x: 400, y: -100 };

        let level6CoinSpawnTimer = 0;
        let level6CoinsSpawned = 0;
        let level6IntroStep = 0; // 0-4: Dialogs, 5: Playing

        let level6IntroTimer = 0;
        let level6OutroActive = false;
        let level6OutroTimer = 0;
        let level6OutroComplete = false;
        let level6OutroFade = 0; // New variable for fade effect
        let level6IntroSeen = false;
        let karczmarzHitCount = 0;
        let armorDropped = false;
        let level6GameplayTimer = 0;
        let timeFreezeActive = false;
        let timeFreezeTimer = 0;
        let lastHourglassSpawnTime = 0; // Track last spawn time

        let lastTime = 0;
        let shotPressedPrev = false; // For debouncing skip

        // Input Utilities
        function setupControls() {
            const bind = (id, key) => {
                const el = document.getElementById(id);
                if (!el) return;

                el.addEventListener('pointerdown', (e) => {
                    e.target.setPointerCapture(e.pointerId);
                    keys[key] = true;
                    if (key === 'jump') playSFX(sfxJump);
                });

                const release = (e) => {
                    keys[key] = false;
                };

                el.addEventListener('pointerup', release);
                el.addEventListener('pointercancel', release);
                // pointerleave usuniƒôty, aby ruch nie przerywa≈Ç siƒô przy lekkim zsuniƒôciu palca
            };

            bind('btn-left', 'left');
            bind('btn-right', 'right');
            bind('btn-jump', 'jump');
            bind('btn-shoot', 'shoot');
            bind('btn-down', 'down');


            window.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = true;
                if (e.key === 'ArrowRight' || e.key === 'd') keys.right = true;
                if (e.key === 'ArrowDown' || e.key === 's') keys.down = true;
                if (e.key === 'x' || e.key === 'X') keys.shoot = true;
                if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'Space' || e.key === ' ') {
                    keys.jump = true;
                }
                if (e.key === 'l' || e.key === 'L') {
                    nextLevel();
                }
            });
            window.addEventListener('keyup', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = false;
                if (e.key === 'ArrowRight' || e.key === 'd') keys.right = false;
                if (e.key === 'ArrowDown' || e.key === 's') keys.down = false;
                if (e.key === 'x' || e.key === 'X') keys.shoot = false;
                if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'Space' || e.key === ' ') keys.jump = false;
            });
        }

        function setControlLayout(type) {
            const btnJump = document.getElementById('btn-jump');
            const dPad = document.querySelector('.d-pad');
            const actionBtns = document.querySelector('.action-btns');
            const spacer = document.getElementById('btn-jump-mobile');
            const btnImages = document.querySelectorAll('.layout-btn-img');

            if (!btnJump || !dPad || !actionBtns || !spacer) return;

            // Update Active UI
            btnImages.forEach(img => img.classList.remove('active'));
            if (type === 'default') btnImages[0].classList.add('active');
            if (type === 'keyboard') btnImages[1].classList.add('active');

            if (type === 'keyboard') {
                // Move Jump to D-Pad and HIDE spacer
                spacer.style.display = 'none'; // Hide spacer so Jump sits closer to arrows
                dPad.insertBefore(btnJump, dPad.firstChild); // Insert at very top
            } else {
                // Move Jump back and SHOW spacer
                spacer.style.display = 'block';
                actionBtns.appendChild(btnJump);
            }
        }
        function initLevel() {
            // Clear existing notifications
            document.querySelectorAll('.game-notification').forEach(n => n.remove());

            generateLevel(level);

            // Cache level assets for performance
            const schemeLvl = COLOR_SCHEMES[(level - 1) % COLOR_SCHEMES.length];
            currentLevelTlo = imgTlo[level - 1] || imgTlo[0];

            // Pre-render background when all assets are ready
            if (currentLevelTlo.complete) {
                preRenderBackground();
            } else {
                currentLevelTlo.onload = preRenderBackground;
            }
            if (level === 7) {
                currentLevelPodloga = imgPodlogaBoss;
                currentLevelBelka = imgBelkaBoss;
            } else {
                currentLevelPodloga = imgPodlogiLevel[level] || imgPodloga;
                currentLevelBelka = imgPodlogiLevel[level] || imgBelka;
            }

            player.x = 50;
            player.y = GAME_HEIGHT - player.height - 50;
            player.vx = 0;
            player.vy = 0;
            player.onGround = false;
            player.shieldLevel = 0;
            player.shieldLevel = 0;
            player.isSober = false;
            player.soberArmor = 0; // 0=fresh, 1=peka1, 2=peka2, 3=peka3, 4=peka4
            player.isAutoWalking = false;
            player.width = 70;
            player.height = 70;
            coinsCollected = 0;
            showCelebration = false;
            abductionPhase = 0;
            soberFreezeTimer = 0; // Timer for the red pause effect
            updateUI();

            // Optymalizacja DOM: Aktualizacja kolor√≥w tylko raz na poziom
            const schemeStyle = COLOR_SCHEMES[(level - 1) % COLOR_SCHEMES.length];
            document.documentElement.style.setProperty('--accent', schemeStyle.accent);
            // Poziom 6: Ciemna ziele≈Ñ zamiast jasnej (ra≈ºƒÖcej)
            if (level === 6) {
                document.documentElement.style.setProperty('--bg', '#1a3a1a'); // Ciemna ziele≈Ñ
            } else {
                document.documentElement.style.setProperty('--bg', schemeStyle.bg);
            }

            setTimeout(() => {
                if (gameState === 'playing') {
                    if (level === 1) showGenericNotification('<img src="zbierz.webp" style="max-width: 100%;">', 'transparent');
                    else if (level === 2) showShootNotification();
                    else if (level === 3) showGenericNotification('<img src="alkohol_nie.webp" style="max-width: 100%;">', 'transparent');
                    else if (level === 4) showGenericNotification('<img src="alkohol_szkodzi.webp" style="max-width: 100%;">', 'transparent');
                    else if (level === 5) showGenericNotification('<img src="info_5.png" style="max-width: 100%;">', 'transparent');
                    else if (level === 7) showGenericNotification('<img src="chmielus.png" style="max-width: 100%;">', 'transparent');
                }
            }, 1000);
        }
        function generateLevel(lvl) {
            platforms = [{ x: 0, y: GAME_HEIGHT - 40, width: GAME_WIDTH, height: 40, isGround: true }];
            enemies = [];
            bullets = [];
            playerBullets = [];
            effects = [];
            coins = [];
            items = [];
            boss = null;

            if (lvl <= 6) {
                // Fixed platforms on sides (5 on each side)
                for (let i = 0; i < 5; i++) {
                    const yPos = 120 + (i * 90);
                    platforms.push({ x: 20, y: yPos, width: 120, height: 20, isGround: false });
                    platforms.push({ x: GAME_WIDTH - 140, y: yPos, width: 120, height: 20, isGround: false });
                }

                // Fixed middle platforms (3 short ones)
                const middleWidth = (lvl === 4 || lvl === 3) ? 120 : 80;
                platforms.push({ x: GAME_WIDTH / 2 - middleWidth / 2, y: 200, width: middleWidth, height: 20, isGround: false });
                platforms.push({ x: GAME_WIDTH / 2 - middleWidth / 2, y: 350, width: middleWidth, height: 20, isGround: false });
                platforms.push({ x: GAME_WIDTH / 2 - middleWidth / 2, y: 500, width: middleWidth, height: 20, isGround: false });

                enemies = [];
                bullets = [];
                if (lvl === 1 || lvl === 2) {
                    const enemyCount = lvl === 1 ? 4 : 2;
                    const spawnWidth = GAME_WIDTH - 300;
                    const step = lvl === 1 ? spawnWidth / (enemyCount - 1) : 400;
                    for (let i = 0; i < enemyCount; i++) {
                        let shootType = lvl === 2 ? 'horizontal' : 'none';
                        enemies.push({
                            x: lvl === 1 ? 150 + (i * step) : 200 + (i * step),
                            y: GAME_HEIGHT - 85,
                            width: 40,
                            height: 50,
                            hp: 2,
                            shootType: shootType,
                            shootTimer: 100 + Math.random() * 300
                        });
                    }
                    if (lvl === 2) {
                        // 3rd enemy on middle right side platform (yPos for i=2 is 300)
                        enemies.push({ x: GAME_WIDTH - 120, y: 300 - 50, width: 40, height: 50, hp: 2, shootType: 'horizontal', shootTimer: 150 });
                    }
                } else if (lvl === 3) {
                    // Level 3: 2 shooters - ground and middle right
                    enemies.push({ x: 300, y: GAME_HEIGHT - 85, width: 40, height: 50, hp: 2, shootType: 'aimed', shootTimer: 100 });
                    enemies.push({ x: GAME_WIDTH - 100, y: 300 - 50, width: 40, height: 50, hp: 2, shootType: 'aimed', shootTimer: 200 });
                    // Additional enemies on right side beams (2nd from bottom and bottom)
                    // Beams at indices 3 and 4 -> center roughly GAME_WIDTH - 100
                    enemies.push({ x: GAME_WIDTH - 100, y: 390 - 50, width: 40, height: 50, hp: 2, shootType: 'aimed', shootTimer: 250 });
                    enemies.push({ x: GAME_WIDTH - 100, y: 480 - 50, width: 40, height: 50, hp: 2, shootType: 'aimed', shootTimer: 280 });

                    // Shield on 2nd platform from bottom on the left (i=3 per loop logic)
                    items.push({ x: 80, y: 390 - 40, type: 'shield', collected: false });
                } else if (lvl === 4) {
                    // Level 4: 6 shooters - ground, middle right, middle bottom beam, upper right, + 2 extra on right side beams
                    enemies.push({ x: 400, y: GAME_HEIGHT - 85, width: 40, height: 50, hp: 2, shootType: 'aimed', shootTimer: 100 });
                    enemies.push({ x: GAME_WIDTH - 100, y: 120 - 50, width: 40, height: 50, hp: 2, shootType: 'aimed', shootTimer: 250 });
                    // Extra 2 kufles on right side beams (idx 4 and 7 usually)
                    enemies.push({ x: GAME_WIDTH - 150, y: 300 - 50, width: 40, height: 50, hp: 2, shootType: 'aimed', shootTimer: 160 });
                    enemies.push({ x: GAME_WIDTH - 150, y: 480 - 50, width: 40, height: 50, hp: 2, shootType: 'aimed', shootTimer: 130 });
                    enemies.push({ x: GAME_WIDTH - 150, y: 560 - 50, width: 40, height: 50, hp: 2, shootType: 'aimed', shootTimer: 150 });

                    // Double Shield on 2nd platform from bottom on the left (i=3)
                    items.push({ x: 80, y: 390 - 45, type: 'doubleShield', collected: false });
                }

                if (lvl >= 5) {
                    if (lvl === 6) {
                        // Level 6: COMPLEX LAYOUT & FALLING COINS & KARCZMARZ
                        platforms = [{ x: 0, y: GAME_HEIGHT - 40, width: GAME_WIDTH, height: 40, isGround: true }];
                        enemies = [];
                        coins = [];

                        // 3 Columns of Moving Platforms
                        // Left Column (x=50)
                        platforms.push({ x: 50, y: 450, width: 100, height: 20, isGround: false, moving: true, minY: 150, maxY: 450, vy: -1.5 });
                        // Middle Column (x=350)
                        platforms.push({ x: 350, y: 150, width: 100, height: 20, isGround: false, moving: true, minY: 150, maxY: 450, vy: 1.5 });
                        // Right Column (x=650)
                        platforms.push({ x: 650, y: 300, width: 100, height: 20, isGround: false, moving: true, minY: 150, maxY: 450, vy: -1.0 });

                        // Static Connectors
                        // Left-Mid connector
                        platforms.push({ x: 180, y: 300, width: 140, height: 20, isGround: false });
                        // Mid-Right connector
                        platforms.push({ x: 480, y: 300, width: 140, height: 20, isGround: false });

                        // Extra beams BELOW static connectors (User request)
                        platforms.push({ x: 180, y: 420, width: 140, height: 20, isGround: false });
                        platforms.push({ x: 480, y: 420, width: 140, height: 20, isGround: false });

                        // Short beams above start (Left) and End (Right)
                        platforms.push({ x: 20, y: GAME_HEIGHT - 120, width: 80, height: 20, isGround: false });
                        platforms.push({ x: GAME_WIDTH - 100, y: GAME_HEIGHT - 120, width: 80, height: 20, isGround: false });

                        // KARCZMARZ ENEMY
                        enemies.push({
                            x: GAME_WIDTH - 100,
                            y: GAME_HEIGHT - 100, // Adjusted Y for smaller height
                            width: 60, // Smaller size (Short)
                            height: 70,
                            hp: 15, // Mini-boss HP
                            type: 'karczmarz',
                            vx: -2,
                            shootTimer: 240, // Slower (approx 4s)
                            aiPhase: 'aimed', // 'aimed' or 'vertical'
                            type: 'karczmarz',
                            vx: -2,
                            shootTimer: 240, // Slower (approx 4s)
                            aiPhase: 'aimed', // 'aimed' or 'vertical'
                            aiShotCount: 0,
                            stunTimer: 0,
                            stunCooldown: 0
                        });

                        // Falling Coins Setup
                        // We do NOT generate initial coins. They will spawn in update()
                        coinsCollected = 0;
                        level6CoinSpawnTimer = 0;
                        level6CoinsSpawned = 0;

                        // Intro Setup
                        level6IntroStep = 0;
                        level6IntroTimer = 0;
                        level6OutroActive = false;
                        level6OutroTimer = 0;
                        level6OutroComplete = false;
                        level6IntroTimer = 0;
                        level6OutroActive = false;
                        level6OutroTimer = 0;
                        level6OutroComplete = false;
                        level6OutroFade = 0; // Reset fade
                        karczmarzHitCount = 0;
                        armorDropped = false;
                        level6GameplayTimer = 0;
                        timeFreezeActive = false;
                        timeFreezeTimer = 0;
                        lastHourglassSpawnTime = 0; // Reset spawn timer

                        player.x = 100;
                        player.y = GAME_HEIGHT - 120 - player.height;

                        // Skip intro on retry
                        if (level6IntroSeen) {
                            level6IntroStep = 5;
                            // Spawn armor immediately when skipping intro
                            const rx = 50 + Math.random() * (GAME_WIDTH - 100);
                            const ry = 150 + Math.random() * (300);
                            items.push({ x: rx, y: ry, type: 'doubleShield', collected: false });
                        } else {
                            level6IntroSeen = true;
                        }
                    } else if (lvl === 5) {
                        // Level 5: Custom Moving Platform
                        platforms = [{ x: 0, y: GAME_HEIGHT - 40, width: GAME_WIDTH, height: 40, isGround: true }];
                        enemies = [];
                        coins = [];

                        // 1. Side Beams (Same as Level 4)
                        for (let i = 0; i < 5; i++) {
                            const yPos = 120 + (i * 90);

                            // Left
                            const pLeft = { x: 20, y: yPos, width: 120, height: 20, isGround: false };
                            platforms.push(pLeft);

                            // Blue Armor on Top Left Beam (i=0)
                            if (i === 0) {
                                items.push({ x: pLeft.x + pLeft.width / 2, y: pLeft.y - 45, type: 'doubleShield', collected: false });
                            }

                            // Coins on Left
                            let count = 2;
                            for (let k = 0; k < count; k++) {
                                let spacing = pLeft.width / (count + 1);
                                coins.push({ x: pLeft.x + spacing * (k + 1), y: pLeft.y - 25, collected: false });
                            }

                            // Right
                            const pRight = { x: GAME_WIDTH - 140, y: yPos, width: 120, height: 20, isGround: false };
                            platforms.push(pRight);
                            // Coins on Right
                            for (let k = 0; k < count; k++) {
                                let spacing = pRight.width / (count + 1);
                                coins.push({ x: pRight.x + spacing * (k + 1), y: pRight.y - 25, collected: false });
                            }
                            // Enemy on Right (Aimed Shooter)
                            enemies.push({
                                x: pRight.x + pRight.width / 2 - 20,
                                y: pRight.y - 50,
                                width: 40,
                                height: 50,
                                hp: 2,
                                shootType: 'aimed',
                                shootTimer: 100 + Math.random() * 200
                            });
                        }

                        // 2. Middle Moving Platform
                        // Moves between bottom-left beam (i=4, y=480) and 4th-from-bottom (i=1, y=210)
                        const pMove = {
                            x: GAME_WIDTH / 2 - 60, // Width 120
                            y: 480,
                            width: 120,
                            height: 20,
                            isGround: false,
                            moving: true,
                            minY: 210,
                            maxY: 480,
                            vy: -1.0 // Slow speed up
                        };
                        platforms.push(pMove);

                        // Enemy on Moving Platform (Spread Shooter)
                        enemies.push({
                            x: pMove.x + pMove.width / 2 - 20,
                            y: pMove.y - 50,
                            width: 40,
                            height: 50,
                            hp: 3, // Slightly stronger
                            shootType: 'spread_left',
                            shootTimer: 120,
                            attachedTo: pMove,
                            offsetX: pMove.width / 2 - 20
                        });

                        // 4 Coins attached to moving platform
                        for (let k = 0; k < 4; k++) {
                            let spacing = pMove.width / (5);
                            coins.push({
                                x: pMove.x + spacing * (k + 1),
                                y: pMove.y - 25,
                                collected: false,
                                attachedTo: pMove,
                                offsetX: spacing * (k + 1)
                            });
                        }

                        // Enemy on Ground Right (Aimed Shooter at Player)
                        enemies.push({
                            x: GAME_WIDTH - 100,
                            y: GAME_HEIGHT - 85,
                            width: 40,
                            height: 50,
                            hp: 2,
                            shootType: 'aimed',
                            shootTimer: 150
                        });

                        // 3. Ground Coins
                        // User requested "ostatnie dwa coiny umie≈õƒá na pod≈Çodze na samym dole, po prawej stronie ekranu obok siebie"

                        // Ground Right (As requested)
                        coins.push({ x: GAME_WIDTH - 60, y: GAME_HEIGHT - 80, collected: false });
                        coins.push({ x: GAME_WIDTH - 100, y: GAME_HEIGHT - 80, collected: false });

                        // Ground Left (Added to reach 28 total coins, to balance gameplay)
                        coins.push({ x: 60, y: GAME_HEIGHT - 80, collected: false });
                        coins.push({ x: 100, y: GAME_HEIGHT - 80, collected: false });

                        // Total Calculation:
                        // Sides: 10 beams * 2 coins = 20.
                        // Middle: 4 coins.
                        // Ground: 4 coins.
                        // Total = 28. Perfect.
                    }
                }


                // Coins - Explicit distribution (Levels 1-4)
                if (lvl <= 4) {
                    coins = [];
                    platforms.forEach((p, idx) => {
                        if (p.isGround) return;
                        // Logic: 
                        // Left side: idx 0(mid), 3(bot), 6(top)
                        // Right side: idx 1(mid), 4(bot), 7(top)
                        // Middle: idx 2(mid), 5(bot), 8(top)
                        // Wait, our platform layout is usually:
                        // 0,1,2 (Top), 3,4,5 (Mid), 6,7,8 (Bot) - let's check initLevel/generateLevel layout
                        const col = idx % 3; // 0:Left, 1:Right, 2:Middle
                        const row = Math.floor(idx / 3); // 0:Top, 1:Mid, 2:Bot

                        // HIDE COINS ON BOSS LEVEL
                        if (lvl === 7) {
                            // Do not generate coins for level 7
                        } else if (lvl >= 5) {
                            // Coins already generated for levels 5 & 6 in specific block
                        } else {
                            let count = 2;
                            if ((col === 0 || col === 1) && row === 0) {
                                count = 4; // Top side beams
                            }

                            if (col === 2) {
                                // All middle beams: 2 coins
                                count = 2;
                            }

                            for (let i = 0; i < count; i++) {
                                let spacing = p.width / (count + 1);
                                coins.push({ x: p.x + spacing * (i + 1), y: p.y - 25, collected: false });
                            }
                        }
                    });
                }
            } else if (lvl === 7) {
                // BOSS LEVEL - Simplified
                // BOSS LEVEL - Manualne ustawienie belek
                // format: { x: POZYCJA_X, y: POZYCJA_Y, width: SZEROKOSC, height: 20, isGround: false }

                // Belka 1 (G√≥rna)
                platforms.push({ x: 400, y: 150, width: 160, height: 30, isGround: false });

                // Belka 2 (≈örodkowa)
                platforms.push({ x: 100, y: 300, width: 100, height: 30, isGround: false });

                // Belka 3 (Dolna - przyk≈Çad innej pozycji)
                platforms.push({ x: 200, y: 250, width: 100, height: 30, isGround: false });

                // Belka 4 (Dolna - przyk≈Çad innej pozycji)
                platforms.push({ x: 50, y: 450, width: 100, height: 30, isGround: false });

                items.push({ x: 450, y: 150 - 50, type: 'sober', collected: false });

                // PRZYWR√ìCONE: PoczƒÖtkowi przeciwnicy - strzelanie jak na poziomie 4 (shootType: 'aimed')
                enemies.push({ x: 410, y: 150 - 50, width: 40, height: 50, hp: 2, shootType: 'aimed', shootTimer: 100 }); // G√≥rna belka
                enemies.push({ x: GAME_WIDTH - 200, y: GAME_HEIGHT - 85, width: 40, height: 50, hp: 2, shootType: 'aimed', shootTimer: 200 }); // Pod bossem

                boss = {
                    x: GAME_WIDTH - 220,
                    y: GAME_HEIGHT / 2 - 100,
                    width: 180,
                    height: 220,
                    hp: 200,
                    maxHp: 200,
                    flash: 0,
                    phase: 'upper',
                    phaseTimer: 240, // 4 seconds between shots
                    phaseIndex: 0,
                    spawnTimer: 900, // üëà Dodaj tƒô liniƒô
                    // ... reszta w≈Ça≈õciwo≈õci ...
                    attackCount: 0,
                    laserActive: 0,
                    laserY: 0,
                    spawnedMidHpEnemy: false,
                    event170: false,
                    event150: false,
                    event100: false,
                    event60: false,
                    event50: false,
                    event40: false,
                    event30: false,
                    showNiePij: 0
                };
            }
        }

        function startGame() {
            if (!assets.isReady) return;
            playSFX(sfxButton);
            bgMusic.volume = 0.4;
            bgMusicBoss.pause();
            bgMusicBoss.currentTime = 0;
            bgMusicBoss.currentTime = 0;
            bgMusicEnding.pause();
            bgMusicEnding.currentTime = 0;
            bgMusicKarczma.pause();
            bgMusicKarczma.currentTime = 0;
            bgMusic.currentTime = 0;
            musicStarted = false;
            level6IntroSeen = false; // Reset seen flag on full restart
            startMusic();
            level = 1; score = 0; totalScore = 0; lives = MAX_LIVES;
            initLevel();
            gameState = 'playing';
            introTimer = 0; // Reset intro
            document.body.classList.add('playing');
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('controls-settings').classList.add('hidden');
            document.getElementById('gameover').classList.add('hidden');
            document.getElementById('level-complete').classList.add('hidden');
            document.getElementById('final-screen').classList.add('hidden');
        }

        function showShootNotification() {
            showGenericNotification('<img src="strzelaj.webp" style="max-width: 100%;">', 'transparent');
        }

        function showGenericNotification(html, color) {
            const notify = document.createElement('div');
            notify.className = 'game-notification';
            notify.style.position = 'absolute';
            notify.style.top = '20%'; // Always on top as requested
            notify.style.left = '50%';
            notify.style.transform = 'translate(-50%, -50%)';
            notify.style.opacity = '0';
            notify.style.transition = 'opacity 1s';
            if (color !== 'transparent') {
                notify.style.background = color;
                notify.style.padding = '10px 20px';
                notify.style.borderRadius = '10px';
                notify.style.boxShadow = '0 0 10px rgba(0,0,0,0.3)';
            }
            notify.style.color = 'white';
            notify.style.fontSize = '1.2rem';
            notify.style.fontWeight = 'bold';
            notify.style.textAlign = 'center';
            notify.style.zIndex = '500';
            notify.style.maxWidth = '80%';
            notify.innerHTML = html;

            // Re-ensure no older notifications stay behind
            document.querySelectorAll('.game-notification').forEach(n => {
                if (n !== notify) {
                    n.style.opacity = '0';
                    setTimeout(() => n.remove(), 500);
                }
            });

            document.getElementById('game-container').appendChild(notify);

            // Fade-in trigger
            setTimeout(() => notify.style.opacity = '1', 50);
            setTimeout(() => {
                notify.style.opacity = '0';
                setTimeout(() => notify.remove(), 1000);
            }, 3000);
        }

        function spawnHourglass() {
            // Spawn hourglass at random location
            const rx = 100 + Math.random() * (GAME_WIDTH - 200);
            const ry = 150 + Math.random() * (300);
            items.push({ x: rx, y: ry, type: 'hourglass', collected: false });
        }

        function nextLevel() {
            playSFX(sfxButton);
            bgMusic.volume = 0.4;
            level++;
            introTimer = 0;
            if (level === 7) {
                bgMusicKarczma.pause();
                bgMusic.pause(); // Safety
                musicStarted = false;
                startMusic();
            } else if (level === 6) {
                bgMusic.pause();
                musicStarted = false;
                startMusic();
            }
            totalScore += score;
            score = 0;
            initLevel();
            gameState = 'playing';
            document.body.classList.add('playing');
            document.getElementById('level-complete').classList.add('hidden');
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('gameover').classList.add('hidden');
        }

        function updateUI() {
            // Ukryj licznik coin√≥w TYLKO na poziomie bossa (7)
            const coinsElement = document.getElementById('coins-ui').parentElement;
            if (level === 7) {
                coinsElement.style.display = 'none';
            } else {
                coinsElement.style.display = '';
            }

            const target = level === 6 ? 56 : COINS_TO_WIN;
            document.getElementById('coins-ui').innerText = `${coinsCollected} / ${target}`;
            document.getElementById('lives-ui').innerText = lives;
            document.getElementById('level-ui').innerText = level;
        }

        function loseLife() {
            if (player.invincibilityTimer > 0 || timeFreezeActive) return; // Ignore damage if invincible or time freeze active

            if (player.isSober && level === 7) {
                if (player.soberArmor < 4) {
                    player.soberArmor++;
                    if (player.soberArmor === 4) {
                        // Reset size to normal
                        const oldH = player.height;
                        player.height = 70;
                        player.width = 70;
                        player.y += (oldH - 70); // Drop down to align feet
                        // player.isSober = true; // Keep true to render peka4
                    }
                    playSFX(sfxShot); // D≈∫wiƒôk uderzenia w pancerz
                    effects.push({ x: player.x + player.width / 2, y: player.y + player.height / 2, type: 'cloud', timer: 30 });
                    player.invincibilityTimer = 60; // 1 second of i-frames (60 frames)
                    return;
                }
            }

            if (player.shieldLevel > 0) {
                // If Blue (2), 1st hit drops to Green (1). 2nd hit returns to Normal (0).
                player.shieldLevel--;
                effects.push({ x: player.x + player.width / 2, y: player.y + player.height / 2, type: 'cloud', timer: 30 });
                player.invincibilityTimer = 60; // 1 second of i-frames
                updateUI();
                return;
            }
            lives--;
            updateUI();
            if (lives <= 0) {
                gameState = 'gameover';
                document.body.classList.remove('playing');
                document.getElementById('gameover').classList.remove('hidden');
            } else {
                initLevel();
                player.invincibilityTimer = 120; // Longer i-frames after respawm (2 seconds)
            }
        }

        let introTimer = 0;
        const INTRO_DURATION = 10000; // 10s

        function update() {
            if (gameState !== 'playing' && gameState !== 'celebrating') return;

            // dt removed, game speed now depends on FPS

            if (player.isAutoWalking) {
                const targetX = GAME_WIDTH / 2 - player.width / 2;
                const dist = targetX - player.x;
                if (Math.abs(dist) > 5 || !player.onGround) {
                    player.vx = Math.sign(dist) * MOVE_SPEED * 0.7;
                    player.facingRight = dist > 0;
                    if (Math.abs(dist) > 5) player.x += player.vx;
                } else {
                    player.x = targetX;
                    player.vx = 0;
                    player.isAutoWalking = false;
                    startUfoAbduction();
                }

                // Keep physics for auto-walk (gravity/platforms)
                player.vy += 0.8;
                player.y += player.vy;
                player.onGround = false;
                platforms.forEach(p => {
                    // Ignoruj piƒôtra (beiki) podczas auto-walku, ≈ºeby bohater spad≈Ç na ziemiƒô
                    if (!p.isGround) return;

                    if (player.x + 10 < p.x + p.width && player.x + player.width - 10 > p.x &&
                        player.y + player.height > p.y && player.y + player.height < p.y + p.height + player.vy + 5 && player.vy >= 0) {
                        player.y = p.y - player.height; player.vy = 0; player.onGround = true;
                    }
                });
                return;
            }

            if (showCelebration) return;

            // Level 6 Outro: Collected all coins
            if (level === 6 && coinsCollected >= 56 && !level6OutroActive) {
                level6OutroActive = true;
                level6OutroTimer = 0;
            }

            if (level6OutroActive) {
                if (level6OutroTimer === 0) playSFX(sfxButton); // Add sound

                // Only increment timer if not fully faded
                if (level6OutroFade < 1) {
                    if (level6OutroFade === 0) {
                        level6OutroTimer += 16.6;
                        // Allow skip with shoot - jumps to fade start
                        if (keys.shoot && !shotPressedPrev) {
                            level6OutroTimer = 6001;
                        }
                        shotPressedPrev = keys.shoot;
                    }

                    // After 6 seconds (previously 4), start fading
                    if (level6OutroTimer > 6000) {
                        level6OutroFade += 0.01; // Fade speed (approx 1.5s)
                    }
                } else {
                    // Fade complete (>= 1)
                    level6OutroActive = false;
                    level6OutroComplete = true;
                    level6OutroFade = 0;
                    nextLevel(); // Go directly to Boss Level (Level 7)
                    return;
                }
                return;
            }

            // Boss Intro Logic
            if (level === 7 && introTimer < INTRO_DURATION) {
                introTimer += 16.6; // approx 60fps step
                return; // During boss intro, game is paused
            }

            // Level 6 Intro Cutscene
            if (level === 6 && level6IntroStep < 5) {
                if (level6IntroTimer === 0) playSFX(sfxButton); // Sound on step start
                level6IntroTimer += 16.6;
                // Allow skip with shoot button
                if (keys.shoot && !shotPressedPrev) {
                    level6IntroStep++;
                    level6IntroTimer = 0;
                }
                // Auto advance after 4 seconds
                if (level6IntroTimer > 4000) {
                    level6IntroStep++;
                    level6IntroTimer = 0;
                }

                // Trigger notification when cutscene ends (step becomes 5) - Gameplay Starts
                if (level6IntroStep === 5) {
                    showGenericNotification('<img src="karczma.png" style="max-width: 100%;">', 'transparent');

                    // ZMIANA: Pancerz pojawia siƒô losowo tu≈º po dialogach
                    if (!armorDropped) {
                        armorDropped = true;
                        // Random location between X: 50-750, Y: 150-450
                        const rx = 50 + Math.random() * (GAME_WIDTH - 100);
                        const ry = 150 + Math.random() * (300);
                        items.push({ x: rx, y: ry, type: 'doubleShield', collected: false });
                    }
                }

                shotPressedPrev = keys.shoot; // Track previous state to prevent rapid skipping
                return; // Pause game logic during cutscene
            }
            shotPressedPrev = keys.shoot;

            // BONUS: Klepsydra Logic
            if (timeFreezeActive) {
                timeFreezeTimer--;
                if (timeFreezeTimer <= 0) {
                    timeFreezeActive = false;
                    // Restore background music volume
                    if (level === 6) {
                        bgMusicKarczma.volume = 0.4;
                    }
                }
            } else if (level === 6 && level6IntroStep === 5) {
                // Gameplay active, no freeze
                level6GameplayTimer += 16.6; // ms
                const seconds = level6GameplayTimer / 1000;

                // Spawn hourglass: first at 18s, then every 15s
                if (seconds >= 18 && lastHourglassSpawnTime === 0) {
                    // First spawn at 18 seconds
                    lastHourglassSpawnTime = level6GameplayTimer;
                    spawnHourglass();
                } else if (lastHourglassSpawnTime > 0 && (seconds - lastHourglassSpawnTime / 1000) >= 15) {
                    // Subsequent spawns every 15 seconds
                    lastHourglassSpawnTime = level6GameplayTimer;
                    spawnHourglass();
                }
            }

            // Moving Platforms Logic (Level 5 & 6)
            platforms.forEach(p => {
                if (p.moving) {
                    // STOP PLATFORMS IF FREEZE ACTIVE
                    if (timeFreezeActive) return;

                    p.y += p.vy;
                    if (p.y <= p.minY || p.y >= p.maxY) {
                        p.vy *= -1;
                    }
                }
            });

            // Attached Coins Logic
            coins.forEach(c => {
                if (c.attachedTo) {
                    c.y = c.attachedTo.y - 25;
                    c.x = c.attachedTo.x + c.offsetX;
                }
            });

            // Level 6 Falling Coins Logic
            if (level === 6) {
                if (level6CoinsSpawned < 56) { // Target 84 total spawns
                    level6CoinSpawnTimer++;
                    // Spawn every ~0.8 seconds (50 frames)
                    if (level6CoinSpawnTimer > 50) {
                        level6CoinSpawnTimer = 0;
                        level6CoinsSpawned++;
                        coins.push({
                            x: 20 + Math.random() * (GAME_WIDTH - 40),
                            y: -50,
                            collected: false,
                            falling: true,
                            vy: 3 // Falling speed
                        });
                    }
                }

                // Physics for falling coins
                coins.forEach(c => {
                    if (c.falling) {
                        // Freeze coins too? User said "platforms stop", "karczmarz stops", "bullets disappear".
                        // Assuming new physics pauses too if we want "everything returns to state".
                        // Coins keep falling during time freeze (removed check)

                        c.y += c.vy;
                        // Stop on platforms
                        platforms.forEach(p => {
                            if (c.x > p.x && c.x < p.x + p.width &&
                                c.y + 10 > p.y && c.y - 10 < p.y) {
                                c.falling = false;
                                c.y = p.y - 25;

                                // Attach to moving platform
                                if (p.moving) {
                                    c.attachedTo = p;
                                    c.offsetX = c.x - p.x;
                                }
                            }
                        });
                        // Stop on ground
                        if (c.y > GAME_HEIGHT - 80) {
                            c.falling = false;
                            c.y = GAME_HEIGHT - 80;
                        }
                    }
                });
            }

            // Karczmarz Logic Update
            enemies.forEach(e => {
                if (e.type === 'karczmarz') {
                    // ZMIANA: Karczmarz NIE zatrzymuje siƒô podczas time freeze
                    // (usuniƒôto warunek: if (timeFreezeActive) return;)

                    // Update Stun Timer
                    if (e.stunTimer > 0) {
                        e.stunTimer--;
                        if (e.stunTimer <= 0) {
                            e.isCiosany = false;
                            e.vx = Math.sign(e.vx) * 2; // Restore speed
                            e.stunCooldown = 0; // Removed cooldown - every hit can now stun
                        }
                    }

                    // Patrol logic (modified for speed)
                    // If stunned, vx should be already slowed.
                    // Just ensure boundary checks preserve current direction sign.
                    if (e.x <= 20) { e.x = 20; e.vx = Math.abs(e.vx); }
                    if (e.x >= GAME_WIDTH - e.width - 20) { e.x = GAME_WIDTH - e.width - 20; e.vx = -Math.abs(e.vx); }
                    e.x += e.vx;

                    // Shooting logic - Karczmarz strzela nawet podczas time freeze

                    e.shootTimer--;
                    if (e.shootTimer <= 0) {
                        if (e.aiPhase === 'aimed') {
                            // Phase 1: Slow Aimed (5 times)
                            const dx = (player.x + player.width / 2) - (e.x + e.width / 2);
                            const dy = (player.y + player.height / 2) - (e.y + 20);
                            const angle = Math.atan2(dy, dx);
                            // Bullet 1 (Slightly up)
                            bullets.push({
                                x: e.x + e.width / 2, y: e.y + 20,
                                vx: Math.cos(angle - 0.1) * 2.5, // Even slower (was 3)
                                vy: Math.sin(angle - 0.1) * 2.5,
                                radius: 12
                            });
                            // Bullet 2 (Slightly down)
                            bullets.push({
                                x: e.x + e.width / 2, y: e.y + 20,
                                vx: Math.cos(angle + 0.1) * 2.5,
                                vy: Math.sin(angle + 0.1) * 2.5,
                                radius: 12
                            });
                            e.aiShotCount++;
                            if (e.aiShotCount >= 5) {
                                e.aiPhase = 'vertical';
                                e.aiShotCount = 0;
                            }
                            playSFX(sfxShotEnemy);
                            e.shootTimer = 240; // 4 seconds between volleys
                        } else {
                            // Phase 2: Fast Vertical (5 times - "w serii")
                            // 2 bullets straight up
                            bullets.push({ x: e.x + e.width / 2 - 10, y: e.y, vx: 0, vy: -6, radius: 12 });
                            bullets.push({ x: e.x + e.width / 2 + 10, y: e.y, vx: 0, vy: -6, radius: 12 });

                            e.aiShotCount++;
                            if (e.aiShotCount >= 5) {
                                e.aiPhase = 'aimed';
                                e.aiShotCount = 0;
                            }
                            playSFX(sfxShotEnemy);
                            e.shootTimer = 40; // Fast fire rate (0.6s)
                        }
                    }
                }
                else if (e.type === 'karczmarz_runner') {
                    // Karczmarz Runner Logic
                    e.x += e.vx; // Move left
                    e.shootTimer--;
                    if (e.shootTimer <= 0) {
                        e.shootTimer = 120; // 2 seconds
                        // Burst Fire (3 shots rapid vertical)
                        bullets.push({ x: e.x + e.width / 2 - 15, y: e.y, vx: 0, vy: -6, radius: 12 });
                        bullets.push({ x: e.x + e.width / 2, y: e.y - 20, vx: 0, vy: -7, radius: 12 });
                        bullets.push({ x: e.x + e.width / 2 + 15, y: e.y, vx: 0, vy: -6, radius: 12 });
                        playSFX(sfxShotEnemy);
                    }
                    if (e.x < -100) e.hp = 0; // Remove if far off screen
                } else if (e.type === 'boss_helper_50') {
                    // Stationary Shooter Logic
                    e.shootTimer--;
                    if (e.shootTimer <= 0) {
                        e.shootTimer = 120; // 2 seconds
                        bullets.push({ x: e.x + 20, y: e.y + 25, vx: -4, vy: -3, radius: 10 });
                        bullets.push({ x: e.x + 20, y: e.y + 25, vx: -4, vy: 3, radius: 10 });
                        playSFX(sfxShotEnemy);
                    }
                }
            });

            // Attached Enemies Logic
            enemies.forEach(e => {
                if (e.attachedTo) {
                    e.y = e.attachedTo.y - 50;
                    e.x = e.attachedTo.x + e.offsetX;
                }
            });

            // Sober Freeze Timer
            if (soberFreezeTimer > 0) {
                soberFreezeTimer -= 1;
            }

            // Invincibility Timer
            if (player.invincibilityTimer > 0) {
                player.invincibilityTimer -= 1;
            }

            // Movement
            if (keys.left) { player.vx = -MOVE_SPEED; player.facingRight = false; }
            else if (keys.right) { player.vx = MOVE_SPEED; player.facingRight = true; }
            else { player.vx *= 0.8; }

            // Rising Edge Jump Logic: Jump only on fresh press
            if (keys.jump && !player.prevJumpState && player.onGround) {
                player.vy = JUMP_FORCE;
                player.onGround = false;
                playSFX(sfxJump);
            }

            player.vy += GRAVITY;
            if (!keys.jump && player.vy < -5) player.vy *= 0.6;
            player.x += player.vx;
            player.y += player.vy;

            // Boundaries
            if (player.x < 0) player.x = 0;
            if (player.x > GAME_WIDTH - player.width) player.x = GAME_WIDTH - player.width;

            // Player Shooting
            let shootCooldown = player.isSober ? 150 : 700;
            if (player.isSober && player.soberArmor === 4) {
                shootCooldown = 350 * 1.4; // 40% slower when armor is broken
            }
            if (level >= 2 && keys.shoot) {
                const now = Date.now();
                if (now - player.lastShootTime > shootCooldown) {
                    playerBullets.push({
                        x: player.x + (player.facingRight ? player.width : 0),
                        y: player.y + player.height / 2,
                        vx: player.facingRight ? 15 : -15,
                        vy: 0,
                        owner: 'player',
                        isFlame: player.isSober && player.soberArmor !== 4
                    });
                    player.lastShootTime = now;
                    playSFX(sfxShot);
                }
            }

            for (let i = playerBullets.length - 1; i >= 0; i--) {
                const pb = playerBullets[i];
                pb.x += pb.vx;
                if (pb.x < -10 || pb.x > GAME_WIDTH + 10) {
                    playerBullets.splice(i, 1);
                    continue;
                }

                // Collision with ordinary enemies
                let bulletRemoved = false;
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const e = enemies[j];
                    if (pb.x < e.x + e.width && pb.x + 5 > e.x && pb.y < e.y + e.height && pb.y + 5 > e.y) {

                        if (e.type === 'karczmarz') {
                            // Valid Hit Logic
                            if (!e.wasHit) {
                                karczmarzHitCount++;
                                e.wasHit = true;
                                setTimeout(() => e.wasHit = false, 200);
                            }

                            // Stun Logic - ALWAYS stun on hit (removed cooldown check)
                            if (e.stunTimer <= 0) {
                                e.isCiosany = true;
                                e.stunTimer = 120; // 2 seconds
                                e.vx = Math.sign(e.vx) * 0.5; // Slow down significantly
                            }

                            // Blue Armor Drop Logic (Once per level)
                            // REMOVED: Now drops at start of level
                            /* if (karczmarzHitCount === 4 && !armorDropped) { 
                                ...
                            } */

                            // Don't reduce HP (Invincible)
                        } else {
                            e.hp--;
                        }

                        playSFX('cios');
                        playerBullets.splice(i, 1);
                        bulletRemoved = true;
                        if (e.hp <= 0) {
                            effects.push({ x: e.x + e.width / 2, y: e.y + e.height / 2, type: 'defeat', timer: 90, maxTimer: 90 });
                            enemies.splice(j, 1);
                        }
                        break;
                    }
                }
                if (bulletRemoved) continue;

                // Poprawa hitboxa Bossa - linie 995-1005
                const bossHitMarginX = 30; // Margines poziomy (pocisk trafi g≈Çƒôbiej w sprite)
                const bossHitMarginY = 20; // Margines pionowy
                if (boss && pb.x < boss.x + boss.width - bossHitMarginX && pb.x + 5 > boss.x + bossHitMarginX && pb.y < boss.y + boss.height - bossHitMarginY && pb.y + 5 > boss.y + bossHitMarginY) {
                    const damage = pb.isFlame ? 1.33 : 1;
                    boss.hp -= damage;
                    boss.flash = 5;
                    playerBullets.splice(i, 1);
                    updateUI();
                    if (boss.hp <= 0 && !boss.isDying) {
                        boss.isDying = true;
                        boss.deathTimer = 1500; // Total duration
                    }
                }
            }

            // Shoot button opacity based on level
            const shootBtn = document.getElementById('btn-shoot');
            if (shootBtn) {
                shootBtn.style.opacity = level >= 2 ? '1' : '0.3';
                shootBtn.style.pointerEvents = level >= 2 ? 'auto' : 'none';
            }

            // Collisions
            player.onGround = false;
            platforms.forEach(p => {
                // Simple Jump down logic: ignore platforms if pressing down
                if (keys.down && !p.isGround) {
                    if (player.x < p.x + p.width && player.x + player.width > p.x &&
                        Math.abs((player.y + player.height) - p.y) < 20) {
                        player.y += 12;
                        player.vy = 3;
                    }
                    return;
                }

                if (player.x < p.x + p.width && player.x + player.width > p.x &&
                    player.y + player.height > p.y && player.y + player.height < p.y + p.height + player.vy + 5 &&
                    player.vy >= 0) {
                    player.y = p.y - player.height;
                    player.vy = 0;
                    player.onGround = true;
                }
            });
            if (keys.jump && player.onGround) {
                player.vy = JUMP_FORCE;
                player.onGround = false;
            }

            for (let i = coins.length - 1; i >= 0; i--) {
                const c = coins[i];
                if (!c.collected) {
                    const dx = (player.x + player.width / 2) - c.x;
                    const dy = (player.y + player.height / 2) - c.y;
                    if (Math.sqrt(dx * dx + dy * dy) < 35) {
                        c.collected = true;
                        coinsCollected++;
                        score += 100;
                        playSFX(sfxCoin);
                        document.getElementById('coins-ui').innerText = `${coinsCollected} / ${level === 6 ? 56 : COINS_TO_WIN}`;

                        const winThreshold = level === 6 ? 56 : COINS_TO_WIN;
                        if (coinsCollected >= winThreshold && level < 7) {
                            if (level === 6) {
                                if (!level6OutroComplete && !level6OutroActive) {
                                    level6OutroActive = true;
                                    level6OutroTimer = 0;
                                }
                            } else {
                                player.isAutoWalking = true;
                            }
                        }
                    }
                }
            }

            for (let i = items.length - 1; i >= 0; i--) {
                const it = items[i];
                if (!it.collected) {
                    const dx = (player.x + player.width / 2) - it.x;
                    const dy = (player.y + player.height / 2) - it.y;
                    if (Math.sqrt(dx * dx + dy * dy) < 30) {
                        it.collected = true;
                        if (it.type === 'shield') {
                            player.shieldLevel = 1;
                            // Play power-up sound
                            sfxPowerUp.currentTime = 0;
                            sfxPowerUp.play().catch(() => { });
                        }
                        if (it.type === 'doubleShield') {
                            player.shieldLevel = 2; // 2 hits for Blue armor
                            // Play power-up sound
                            sfxPowerUp.currentTime = 0;
                            sfxPowerUp.play().catch(() => { });
                        }
                        if (it.type === 'hourglass') {
                            // BONUS: Time Freeze Effect - 6.2 seconds
                            timeFreezeActive = true;
                            timeFreezeTimer = 372; // 6.2 seconds at 60 FPS

                            // Play hourglass music
                            sfxKlepsydra.currentTime = 0;
                            sfxKlepsydra.play().catch(() => { });

                            // Lower background music volume
                            if (level === 6) {
                                bgMusicKarczma.volume = 0.15;
                            }

                            // Play power-up sound
                            sfxPowerUp.currentTime = 0;
                            sfxPowerUp.play().catch(() => { });

                            // Clear all bullets when time freezes
                            bullets = [];
                        }
                        if (it.type === 'sober') {
                            const oldHeight = player.height;
                            player.isSober = true;
                            player.height = 100;
                            player.width = 100; // Update width as well for hitbox
                            player.y -= (player.height - oldHeight); // Lift player so feet stay at same Y
                            // Text notification removed as requested

                            // Play power-up sound
                            sfxPowerUp.currentTime = 0;
                            sfxPowerUp.play().catch(() => { });

                            // DYNAMICZNY SPAWN (Level 5) - Na ≈ºyczenie u≈ºytkownika
                            if (level === 7) {
                                // Aktywacja pauzy i d≈∫wiƒôku
                                sfxTrzezwosc.play().catch(() => { });
                                soberFreezeTimer = 240; // 4 seconds freeze

                                // Usu≈Ñ wrog√≥w z "ziemi" (tych nisko po≈Ço≈ºonych), zostaw tylko na belkach
                                enemies = enemies.filter(e => e.y < GAME_HEIGHT - 100);

                                // 1. Dw√≥ch przeciwnik√≥w obok siebie na dole pod Bossem
                                // ZMIANA: U≈ºytkownik chce brak wrog√≥w na ziemi po zebraniu trze≈∫wo≈õci.
                                // Wiƒôc NIE dodajemy tych pod bossem.

                                // 2. Trzeci przeciwnik na belce - USUNIƒòTE na ≈ºyczenie
                                // enemies.push({ x: 80, y: 450 - 50, width: 40, height: 50, hp: 2, shootType: 'aimed', shootTimer: 180 });
                            }
                        }
                    }
                }
            }

            for (let i = enemies.length - 1; i >= 0; i--) {
                const e = enemies[i];
                if (player.x < e.x + e.width && player.x + player.width > e.x &&
                    player.y < e.y + e.height && player.y + player.height > e.y) {
                    // ZMIANA: Nie≈õmiertelno≈õƒá dzia≈Ça te≈º na kolizje z wrogami (w tym karczmarzem)
                    if (player.invincibilityTimer > 0 || timeFreezeActive) {
                        // Gracz jest nie≈õmiertelny - ignoruj kolizjƒô
                        continue;
                    }
                    loseLife();
                    return; // Stop processing this frame after death to avoid freeze/glitches
                }

                // Shooting logic (Level 2+)
                if (level >= 2 && !showCelebration && e.shootType !== 'none' && soberFreezeTimer <= 0) {
                    e.shootTimer -= 1;
                    if (e.shootTimer <= 0) {
                        const dx = (player.x + 15) - (e.x + 20);
                        const dy = (player.y + 25) - (e.y + 25);
                        const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                        let vx = (dx / dist) * 2.5;
                        let vy = (dy / dist) * 2.5;

                        if (e.shootType === 'horizontal') {
                            vx = e.x > player.x ? -2.5 : 2.5;
                            vy = 0;
                        } else if (e.shootType === 'spread_left') {
                            // Double shot: Diagonal Top-Left and Diagonal Bottom-Left
                            bullets.push({ x: e.x + 20, y: e.y + 25, vx: -4, vy: -3, radius: 10 });
                            bullets.push({ x: e.x + 20, y: e.y + 25, vx: -4, vy: 3, radius: 10 });

                            e.shootTimer = 180; // Fixed interval
                            playSFX(sfxShotEnemy);
                            return; // Skip default bullet push
                        }

                        // Use consistent bullet image
                        bullets.push({ x: e.x + 20, y: e.y + 25, vx, vy, radius: 10 });

                        e.shootTimer = 250 + Math.random() * 300;
                        playSFX(sfxShotEnemy);
                    }
                }
            }

            for (let i = effects.length - 1; i >= 0; i--) {
                effects[i].timer -= 1;
                if (effects[i].timer <= 0) effects.splice(i, 1);
            }

            // Boss Logic - Pattern: 3 horizontal shots @ heights + 4s speech bubble
            if (boss && !showCelebration) {
                if (boss.isDying) {
                    boss.deathTimer -= 16.6;
                    boss.flash = 5;
                    // Explosion particles
                    for (let k = 0; k < 2; k++) {
                        effects.push({
                            x: boss.x + Math.random() * boss.width,
                            y: boss.y + Math.random() * boss.height,
                            type: 'particle',
                            timer: 20
                        });
                    }
                    if (boss.deathTimer <= 0) {
                        boss = null;
                        startUfoAbduction();
                    }
                    return;
                }
                if (boss.flash > 0) boss.flash -= 1;

                // SPAWNING: Co 15 sekund pojawia siƒô dw√≥ch przeciwnik√≥w
                if (!boss.spawnTimer) boss.spawnTimer = 0;
                boss.spawnTimer--;
                if (boss.spawnTimer <= 0) {
                    // 1. Wr√≥g na g√≥rnej belce (Poziom 4 - aimed)
                    enemies.push({ x: 430, y: 150 - 50, width: 40, height: 50, hp: 2, shootType: 'aimed', shootTimer: 100 });
                    // 2. Wr√≥g pod Bossem (Poziom 2 - horizontal)
                    enemies.push({ x: GAME_WIDTH - 200, y: GAME_HEIGHT - 85, width: 40, height: 50, hp: 2, shootType: 'horizontal', shootTimer: 200 });

                    boss.spawnTimer = 900; // 15 sekund (60 FPS √ó 15 = 900 fram√≥w)
                }

                // Boss HP Events
                // 170 HP - Karczmarz Runner (Burst)
                if (boss.hp <= 170 && !boss.event170) {
                    boss.event170 = true;
                    // Runs from Right to Left on Ground
                    enemies.push({
                        x: GAME_WIDTH + 50, y: GAME_HEIGHT - 40 - 70, width: 60, height: 70, hp: 5,
                        type: 'karczmarz_runner', vx: -3, shootTimer: 20, speechImg: imgBieg1
                    });

                }
                // 150 HP - LASER BULLET ATTACK
                if (boss.hp <= 150 && !boss.event150) {
                    boss.event150 = true;
                    // Spawn laser bullet at middle height
                    bullets.push({ x: boss.x, y: 300, vx: -4, vy: 0, img: imgLaser, isLaser: true });
                    // Play laser sound
                    sfxLaser.currentTime = 0;
                    sfxLaser.play().catch(() => { });
                }

                // 130 HP - Karczmarz Runner (Burst)
                if (boss.hp <= 130 && !boss.event130) {
                    boss.event130 = true;
                    // Runs from Right to Left on Ground
                    enemies.push({
                        x: GAME_WIDTH + 50, y: GAME_HEIGHT - 40 - 70, width: 60, height: 70, hp: 5,
                        type: 'karczmarz_runner', vx: -3, shootTimer: 20, speechImg: imgBieg1
                    });

                }

                // 90 HP - LASER BULLET ATTACK
                if (boss.hp <= 90 && !boss.event90) {
                    boss.event90 = true;
                    // Spawn laser bullet at middle height
                    bullets.push({ x: boss.x, y: 300, vx: -4, vy: 0, img: imgLaser, isLaser: true });
                    // Play laser sound
                    sfxLaser.currentTime = 0;
                    sfxLaser.play().catch(() => { });
                }
                // 80 HP - Karczmarz Runner + LASER BULLET
                if (boss.hp <= 80 && !boss.event80) {
                    boss.event80 = true;
                    enemies.push({
                        x: GAME_WIDTH + 50, y: GAME_HEIGHT - 40 - 70, width: 60, height: 70, hp: 5,
                        type: 'karczmarz_runner', vx: -3, shootTimer: 20, speechImg: imgBieg2
                    });
                    // Laser bullet at upper height
                    bullets.push({ x: boss.x, y: 200, vx: -4, vy: 0, img: imgLaser, isLaser: true });
                    // Play laser sound
                    sfxLaser.currentTime = 0;
                    sfxLaser.play().catch(() => { });
                }
                // 70 HP - LASER BULLET ATTACK
                if (boss.hp <= 70 && !boss.event70) {
                    boss.event70 = true;
                    // Spawn laser bullet at middle height
                    bullets.push({ x: boss.x, y: 300, vx: -4, vy: 0, img: imgLaser, isLaser: true });
                    // Play laser sound
                    sfxLaser.currentTime = 0;
                    sfxLaser.play().catch(() => { });
                }


                // 60 HP - LASER BULLET ATTACK
                if (boss.hp <= 60 && !boss.event60) {
                    boss.event60 = true;
                    // Spawn laser bullet at middle height
                    bullets.push({ x: boss.x, y: 300, vx: -4, vy: 0, img: imgLaser, isLaser: true });
                    // Play laser sound
                    sfxLaser.currentTime = 0;
                    sfxLaser.play().catch(() => { });
                }

                // 50 HP - LASER BULLET ATTACK
                if (boss.hp <= 50 && !boss.event50) {
                    boss.event50 = true;
                    // Spawn laser bullet at middle height
                    bullets.push({ x: boss.x, y: 300, vx: -4, vy: 0, img: imgLaser, isLaser: true });
                    // Play laser sound
                    sfxLaser.currentTime = 0;
                    sfxLaser.play().catch(() => { });
                }
                // 40 HP - Nie Pij + LASER BULLET
                if (boss.hp <= 40 && !boss.event40) {
                    boss.event40 = true;
                    boss.showNiePij = 300; // 5 seconds
                    // Laser bullet at lower height
                    bullets.push({ x: boss.x, y: 450, vx: -4, vy: 0, img: imgLaser, isLaser: true });
                    // Play laser sound
                    sfxLaser.currentTime = 0;
                    sfxLaser.play().catch(() => { });
                }
                // 30 HP - Karczmarz Runner 3
                if (boss.hp <= 30 && !boss.event30) {
                    boss.event30 = true;
                    enemies.push({
                        x: GAME_WIDTH + 50, y: GAME_HEIGHT - 40 - 70, width: 60, height: 70, hp: 5,
                        type: 'karczmarz_runner', vx: -3, shootTimer: 20, speechImg: imgBieg3
                    });
                }

                if (boss.showNiePij > 0) boss.showNiePij--;

                // Collision with player
                const hitMarginX = 50;
                const hitMarginY = 20;

                if (player.x < boss.x + boss.width - hitMarginX &&
                    player.x + player.width > boss.x + hitMarginX &&
                    player.y < boss.y + boss.height - hitMarginY &&
                    player.y + player.height > boss.y + hitMarginY) {
                    loseLife();
                    return;
                }

                boss.phaseTimer -= 1;
                if (boss.phaseTimer <= 0) {
                    if (boss.phaseIndex < 3) {
                        // Shooting Phase - 2 POCISKI z ka≈ºdej wysoko≈õci
                        const bx = boss.x;
                        let by = 0;
                        if (boss.phaseIndex === 0) by = 210 + 10; // Upper beam
                        else if (boss.phaseIndex === 1) by = 360 + 10; // Middle beam
                        else if (boss.phaseIndex === 2) by = 480 + 10; // Lower beam

                        // Pocisk 1: Poziomy (jak wcze≈õniej)
                        bullets.push({ x: bx, y: by, vx: -5, vy: 0, img: imgDetoks });

                        // Pocisk 2: Uko≈õny w d√≥≈Ç (lekko rozrzucony, mniej stromo)
                        bullets.push({ x: bx, y: by - 20, vx: -5, vy: 0.8, img: imgDetoks });

                        boss.phaseIndex++;
                        boss.phaseTimer = 180; // 3 sekundy (by≈Ço 240 = 4 sekundy)
                    } else {
                        // Po 3 strza≈Çach (phaseIndex === 3), kr√≥tka przerwa i restart
                        boss.phaseIndex = 0;
                        boss.phaseTimer = 60; // Kr√≥tka przerwa 1 sekunda zamiast natychmiastowego restartu
                    }
                }
            }

            if (gameState === 'celebrating' && abductionPhase < 4) {
                const targetX = GAME_WIDTH / 2 - player.width / 2;
                const targetY = GAME_HEIGHT - player.height - 40;
                if (Math.abs(player.x - targetX) > 4) {
                    if (player.x < targetX) { player.x += 2; player.facingRight = true; }
                    else { player.x -= 2; player.facingRight = false; }
                }
                if (Math.abs(player.y - targetY) > 4) {
                    if (player.y < targetY) player.y += 2;
                    else player.y -= 2;
                }
            }

            // Bullet update and collision
            for (let i = bullets.length - 1; i >= 0; i--) {
                const b = bullets[i];
                b.x += b.vx;
                b.y += b.vy;

                if (b.homing && !b.text) {
                    const dx = (player.x + 15) - b.x;
                    const dy = (player.y + 25) - b.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > 1) {
                        b.vx = (b.vx * 0.98) + (dx / dist) * 0.05;
                        b.vy = (b.vy * 0.98) + (dy / dist) * 0.05;
                    }
                }

                // Collision with player
                const dx = (player.x + player.width / 2) - b.x;
                const dy = (player.y + player.height / 2) - b.y;

                let cx = b.x;
                let cy = b.y;
                let bSize = (b.radius ? b.radius + 12 : 12);

                if (boss) {
                    if (b.img) {
                        // Boss bullet image is drawn at b.x, b.y with 96x72 size
                        cx = b.x + 48;
                        cy = b.y + 36;
                        bSize = 25; // Smaller, tighter hitbox
                    } else {
                        bSize = 15;
                    }
                }

                if (player.x < cx + bSize && player.x + player.width > cx - bSize &&
                    player.y < cy + bSize && player.y + player.height > cy - bSize) {
                    bullets.splice(i, 1);

                    // Nie≈õmiertelno≈õƒá ju≈º jest sprawdzana w loseLife(), wiƒôc to dzia≈Ça poprawnie
                    loseLife();
                    return;
                }

                if (b.x < -100 || b.x > GAME_WIDTH + 100 || b.y < -100 || b.y > GAME_HEIGHT + 100) {
                    bullets.splice(i, 1);
                }
            }
        }

        function startUfoAbduction() {
            gameState = 'celebrating';
            showCelebration = true;
            document.body.classList.remove('playing');
            playSFX(sfxUfo);
            bgMusic.volume = 0.2;

            setTimeout(() => abductionPhase = 1, 500);
            setTimeout(() => abductionPhase = 2, 2000);
            setTimeout(() => abductionPhase = 3, 3000);
            setTimeout(() => {
                abductionPhase = 4;
                playerAbductX = player.x;
                playerAbductY = player.y;
                playerAbductStartTime = Date.now();
            }, 4000);
            setTimeout(() => {
                abductionPhase = 5;
                if (level === 7) {
                    startUpliftLevel();
                } else {
                    document.getElementById('level-complete').classList.remove('hidden');
                }
            }, 6500);
        }

        let upliftCameraX = 0;
        let upliftFade = 0;
        let isUpliftFading = false;
        let soberFreezeTimer = 0;

        function startUpliftLevel() {
            gameState = 'uplift';
            document.body.classList.remove('playing');
            document.querySelector('.ui-overlay').style.opacity = '0';

            // Upewnij siƒô, ≈ºe przycisk strzelania jest aktywny na poziomie Uplifting
            const shootBtn = document.getElementById('btn-shoot');
            if (shootBtn) {
                shootBtn.style.opacity = '1';
                shootBtn.style.pointerEvents = 'auto';
            }

            const finalScreen = document.getElementById('final-screen');
            finalScreen.classList.remove('hidden');
            finalScreen.style.display = 'flex';

            // Clean up old elements and text
            finalScreen.innerHTML = '<canvas id="upliftCanvas" width="800" height="600"></canvas>';

            bgMusicBoss.pause();
            bgMusicEnding.play().catch(e => console.log(e));

            const uCanvas = document.getElementById('upliftCanvas');
            const uctx = uCanvas.getContext('2d');
            // uctx.scale(0.5, 0.5); // REMOVED: Native 800x600 resolution

            let pWidth = 157 * (70 / 70);
            let pHeight = 157;
            let px = 100;
            let py = 500;
            let pvy = 0;
            const groundY = 500;
            let pOnGround = true;
            let pFacingRight = true;
            let finalSceneActive = false;
            let finalCutsceneStep = 0;
            let finalTimer = 0;
            let finalOpacity = 0;
            let shakeTimer = 0;
            let currentDialogImg = null;
            let currentBackgroundImg = null;
            let upliftStartTimer = 100; // 3 seconds to show imgWPrawo
            let buttonsAdded = false;
            let shootKeyWasPressed = false;

            upliftCameraX = 0;
            upliftFade = 0;
            isUpliftFading = false;

            // Background dimensions for scaling
            const bgHeightActual = 600;
            const bgScale = (imgPlansza.complete && imgPlansza.height > 0) ? (bgHeightActual / imgPlansza.height) : 1;
            const doorXScaled = 4717 * bgScale;

            let lastFrameTimeUplift = 0;
            function updateUplift(timestamp = performance.now()) {
                const elapsed = timestamp - lastFrameTimeUplift;

                if (elapsed >= FRAME_DURATION) {
                    lastFrameTimeUplift = timestamp - (elapsed % FRAME_DURATION);
                    runUpliftStep();
                }

                if (gameState === 'uplift') {
                    requestAnimationFrame(updateUplift);
                }
            }

            function runUpliftStep() {
                if (gameState !== 'uplift') return;

                const dt_ref = 1; // logical replacement for dt

                if (!finalSceneActive) {
                    if (upliftStartTimer > 0) {
                        upliftStartTimer -= 1;
                    } else {
                        if (keys.left) {
                            px -= 6;
                            pFacingRight = false;
                        }
                        if (keys.right) {
                            px += 6;
                            pFacingRight = true;
                        }
                        if (keys.jump && pOnGround) {
                            pvy = -15;
                            pOnGround = false;
                            playSFX(sfxJump);
                        }
                    }

                    // Gravity and physics
                    pvy += 0.7;
                    py += pvy;
                    if (py >= groundY) {
                        py = groundY;
                        pvy = 0;
                        pOnGround = true;
                    } else {
                        pOnGround = false;
                    }

                    if (px < 50) px = 50;

                    // Boundary check for the end of the level
                    if (imgPlansza.complete) {
                        const bgHeight = 600;
                        const bgScale = bgHeight / imgPlansza.height;
                        const bgWidth = imgPlansza.width * bgScale;
                        const rightLimit = bgWidth - pWidth - 20;
                        if (px > rightLimit) px = rightLimit;
                    }

                    // Scrolling: Follow player
                    const screenCenterX = 400;
                    upliftCameraX = Math.max(0, px - screenCenterX);

                    // Interaction with door
                    const distToDoor = Math.abs(px - doorXScaled);

                    if (distToDoor < 150 && keys.shoot && !isUpliftFading) {
                        isUpliftFading = true;
                        sfxDrzwi.play().catch(() => { });
                    }

                    if (isUpliftFading) {
                        upliftFade += 0.005;
                        if (upliftFade >= 1) {
                            upliftFade = 1;
                            finalSceneActive = true;
                            finalCutsceneStep = 1;
                            finalTimer = 0;
                            currentBackgroundImg = imgOstatniaScena;
                        }
                    }
                } else {
                    // Allow skipping dialogs with shoot key
                    if (keys.shoot && !shootKeyWasPressed) {
                        // Skip many frames if it's a dialog or pause step
                        // (Steps 2, 3, 4, 7 are dialogs)
                        if ([1, 2, 3, 4, 7, 9].includes(finalCutsceneStep)) {
                            finalTimer += 1000; // Jump ahead
                            sfxPrzycisk.currentTime = 0; sfxPrzycisk.play().catch(() => { });
                        }
                    }
                    shootKeyWasPressed = keys.shoot;

                    // Sound trigger for new steps (Dialogues)
                    if ([2, 3, 4, 7].includes(finalCutsceneStep) && finalTimer === 0) {
                        playSFX(sfxButton);
                    }

                    finalTimer += 1;
                    // FINAL CUTSCENE STATE MACHINE
                    if (finalCutsceneStep === 1) { // Show ostatnia_scena.png
                        if (finalTimer > 60) { finalCutsceneStep = 2; finalTimer = 0; }
                    } else if (finalCutsceneStep === 2) { // Dialog 1 (top right)
                        updateDialog(imgDialog1, 900, 0); // 900 frames = 15s
                    } else if (finalCutsceneStep === 3) { // Dialog 2 (top left)
                        updateDialog(imgDialog2, 900, 0);
                    } else if (finalCutsceneStep === 4) { // Dialog 3 (top right)
                        updateDialog(imgDialog3, 900, 0);
                    } else if (finalCutsceneStep === 5) { // Fade to white
                        finalOpacity += 0.01;
                        if (finalOpacity >= 1) {
                            finalOpacity = 1;
                            finalCutsceneStep = 6;
                            finalTimer = 0;
                            currentBackgroundImg = imgAniol;
                        }
                    } else if (finalCutsceneStep === 6) { // Fade from white to aniol.png
                        finalOpacity -= 0.01;
                        if (finalOpacity <= 0) {
                            finalOpacity = 0;
                            finalCutsceneStep = 7;
                            finalTimer = 0;
                        }
                    } else if (finalCutsceneStep === 7) { // Dialog 4 (11 seconds)
                        updateDialog(imgDialog4, 1000, 0);
                    } else if (finalCutsceneStep === 8) { // Violent shake
                        shakeTimer = 30;
                        finalCutsceneStep = 9;
                        finalTimer = 0;
                        currentBackgroundImg = imgAniol2;
                    } else if (finalCutsceneStep === 9) { // Post shake delay
                        if (finalTimer > 300) { finalCutsceneStep = 10; finalTimer = 0; }
                    } else if (finalCutsceneStep === 10) { // Fade to white again
                        finalOpacity += 0.01;
                        if (finalOpacity >= 1) {
                            finalOpacity = 1;
                            finalCutsceneStep = 11;
                            finalTimer = 0;
                        }
                    } else if (finalCutsceneStep === 11) { // Show "dziekuje.jpg" and end
                        if (!buttonsAdded) {
                            buttonsAdded = true;
                            addFinalScreenButtons();
                        }
                    }

                    if (shakeTimer > 0) shakeTimer -= 1;
                }

                drawUplift();
            }

            function updateDialog(img, duration, gap) {
                currentDialogImg = img;
                if (finalTimer < 60) finalOpacity = finalTimer / 60; // Fade in
                else if (finalTimer < duration - 60) finalOpacity = 1; // Stay
                else finalOpacity = (duration - finalTimer) / 60; // Fade out

                if (finalTimer >= duration) {
                    finalCutsceneStep++;
                    finalTimer = 0;
                    finalOpacity = 0;
                    currentDialogImg = null;
                    if (finalCutsceneStep <= 7) { // Play sound on next step start if it's still part of the dialog flow
                        // Sound moved to main loop for immediate trigger
                    }
                }
            }

            function drawUplift() {
                uctx.clearRect(0, 0, 800, 600);

                if (finalSceneActive) {
                    uctx.save();
                    if (shakeTimer > 0) {
                        uctx.translate((Math.random() - 0.5) * 30, (Math.random() - 0.5) * 30);
                    }

                    // Background
                    if (currentBackgroundImg && currentBackgroundImg.complete) {
                        uctx.drawImage(currentBackgroundImg, 0, 0, 800, 600);
                    }

                    // Dialogs
                    if (currentDialogImg && currentDialogImg.complete) {
                        uctx.save();
                        uctx.globalAlpha = finalOpacity;
                        // Positioning
                        // dScale - kontroluje ROZMIAR dialog√≥w (0.28 = 28% oryginalnego rozmiaru)
                        let dScale = 0.30; // Zwiƒôksz warto≈õƒá aby powiƒôkszyƒá dialogi, zmniejsz aby pomniejszyƒá

                        let dw = currentDialogImg.width * dScale;
                        let dh = currentDialogImg.height * dScale;

                        // OSOBNE USTAWIENIA DLA KA≈ªDEGO DIALOGU
                        // Format: uctx.drawImage(obraz, pozycjaX, pozycjaY, szeroko≈õƒá, wysoko≈õƒá)

                        if (currentDialogImg === imgDialog1) {
                            // DIALOG 1 - Wycentrowany
                            let posX = (400 - dw / 2) + 60;  // Poprawiony wz√≥r na centrowanie
                            let posY = 40;
                            uctx.drawImage(currentDialogImg, posX, posY, dw, dh);

                        } else if (currentDialogImg === imgDialog2) {
                            // DIALOG 2 - Wycentrowany z przesuniƒôciem u≈ºytkownika
                            let posX = (400 - dw / 2) - 110;
                            let posY = 40;
                            uctx.drawImage(currentDialogImg, posX, posY, dw, dh);

                        } else if (currentDialogImg === imgDialog3) {
                            // DIALOG 3 - Wycentrowany
                            let posX = (400 - dw / 2) + 60;  // Poprawiony wz√≥r na centrowanie
                            let posY = 40;
                            uctx.drawImage(currentDialogImg, posX, posY, dw, dh);

                        } else if (currentDialogImg === imgDialog4) {
                            // DIALOG 4 - Wycentrowany
                            let posX = (400 - dw / 2) + 60;  // Poprawiony wz√≥r na centrowanie
                            let posY = 40;
                            uctx.drawImage(currentDialogImg, posX, posY, dw, dh);
                        }
                        uctx.restore();
                    }

                    // White flash/fade
                    if (finalCutsceneStep === 5 || finalCutsceneStep === 6 || finalCutsceneStep === 10 || finalCutsceneStep === 11) {
                        uctx.fillStyle = `rgba(255, 255, 255, ${finalOpacity})`;
                        uctx.fillRect(0, 0, 800, 600);
                    }

                    // Final "Dziekuje"
                    if (finalCutsceneStep === 11) {
                        if (imgDziekuje.complete) {
                            const scale = Math.max(800 / imgDziekuje.width, 600 / imgDziekuje.height);
                            const w = imgDziekuje.width * scale;
                            const h = imgDziekuje.height * scale;
                            uctx.drawImage(imgDziekuje, (800 - w) / 2, (600 - h) / 2, w, h);
                        }
                    }

                    uctx.restore();
                    return;
                }

                // Draw background (plansza.png) stretched to height 600
                if (imgPlansza.complete) {
                    const bgHeight = 600;
                    const bgScale = bgHeight / imgPlansza.height;
                    const bgWidth = imgPlansza.width * bgScale;
                    uctx.drawImage(imgPlansza, -upliftCameraX, 0, bgWidth, bgHeight);
                } else {
                    uctx.fillStyle = '#000';
                    uctx.fillRect(0, 0, 800, 600);
                }

                if (imgBohater.complete) {
                    uctx.save();
                    if (!pFacingRight) {
                        uctx.translate(px - upliftCameraX + pWidth, py - pHeight);
                        uctx.scale(-1, 1);
                        uctx.drawImage(imgBohater, 0, 0, pWidth, pHeight);
                    } else {
                        uctx.drawImage(imgBohater, px - upliftCameraX, py - pHeight, pWidth, pHeight);
                    }
                    uctx.restore();
                }

                // Button "przycisk_strzelania.png"
                if (Math.abs(px - doorXScaled) < 150 && !isUpliftFading) {
                    if (imgPrzyciskStrzelania.complete) {
                        uctx.drawImage(imgPrzyciskStrzelania, 400 - 200, 40, 400, 160);
                    }
                }

                // Fade to black
                if (upliftFade > 0 && !finalSceneActive) {
                    uctx.fillStyle = `rgba(0, 0, 0, ${upliftFade})`;
                    uctx.fillRect(0, 0, 800, 600);
                }

                // Go Right indicator at the start
                if (upliftStartTimer > 0) {
                    if (imgWPrawo.complete) {
                        uctx.drawImage(imgWPrawo, 400 - 150, 150, 300, 150);
                    }
                }
            }

            updateUplift();

            function addFinalScreenButtons() {
                const container = document.createElement('div');
                container.id = 'final-buttons-container';
                container.style.position = 'absolute';
                container.style.bottom = '15%';
                container.style.left = '50%';
                container.style.transform = 'translateX(-50%)';
                container.style.display = 'flex';
                container.style.flexDirection = 'column';
                container.style.gap = '20px';
                container.style.zIndex = '300';
                container.style.alignItems = 'center';

                const btnAgain = document.createElement('img');
                btnAgain.src = 'grajponownie.webp';
                btnAgain.style.width = '100px';
                btnAgain.style.cursor = 'pointer';
                btnAgain.onclick = () => location.reload();

                const btnExit = document.createElement('img');
                btnExit.src = 'wyjscie.webp';
                btnExit.style.width = '100px';
                btnExit.style.cursor = 'pointer';
                btnExit.onclick = () => {
                    window.close();
                    alert("Dziƒôkujƒô za grƒô! Mo≈ºesz teraz zamknƒÖƒá kartƒô przeglƒÖdarki.");
                };

                container.appendChild(btnAgain);
                container.appendChild(btnExit);
                const finalScreen = document.getElementById('final-screen');
                if (finalScreen) finalScreen.appendChild(container);
            }
        }

        function drawPlayerOnCtx(c, px, py, right, surprised) {
            let scale = player.isSober ? 1.8 : 1; // 1.8 for Red Armor
            if (player.isSober && player.soberArmor === 4) scale = 1.0; // Reset scale if broken
            if (gameState === 'final') scale = 5.5; // Giant on final screen
            const pw = 70 * scale;
            const ph = 70 * scale;

            if (imgBohater.complete) {
                let currentImg = imgBohater;
                if (player.isSober) {
                    if (level === 7 && player.soberArmor > 0 && player.soberArmor <= 4) {
                        // Boss Armor Damage States
                        if (player.soberArmor === 1) currentImg = imgPancerzPeka1;
                        else if (player.soberArmor === 2) currentImg = imgPancerzPeka2;
                        else if (player.soberArmor === 3) currentImg = imgPancerzPeka3;
                        else if (player.soberArmor === 4) currentImg = imgPancerzPeka4;
                    } else {
                        currentImg = imgPancerzCzerwony;
                    }
                } else if (player.shieldLevel > 0) {
                    if (player.shieldLevel === 2) currentImg = imgPancerzNiebieski; // Level 2 = Blue
                    else currentImg = imgPancerzZielony; // Level 1 = Green
                }
                // No else if (surprised) here, as it would override shield/sober images.
                // If surprised is needed, it should be applied on top or as a separate layer.

                c.save();

                // Blinking effect when invincible OR Time Freeze
                if ((player.invincibilityTimer > 0 || timeFreezeActive) && Math.floor(Date.now() / 100) % 2 === 0) {
                    c.globalAlpha = 0.3;
                }

                if (!right) {
                    c.translate(px + pw, py);
                    c.scale(-1, 1);
                    c.drawImage(currentImg, 0, 0, pw, ph);
                } else {
                    c.drawImage(currentImg, px, py, pw, ph);
                }
                c.restore();
                return;
            }

            // Fallback: Original drawing logic
            // Limbs
            c.strokeStyle = '#ffdbac';
            c.lineWidth = 4 * scale;
            c.lineCap = 'round';

            // Legs
            const walk = Math.abs(Math.sin(Date.now() / 150)) * 10 * scale;
            c.beginPath(); c.moveTo(px + 10 * scale, py + 45 * scale); c.lineTo(px + 10 * scale - walk, py + 55 * scale); c.stroke();
            c.beginPath(); c.moveTo(px + 20 * scale, py + 45 * scale); c.lineTo(px + 20 * scale + walk, py + 55 * scale); c.stroke();

            // Arms
            c.beginPath(); c.moveTo(px + 2 * scale, py + 30 * scale); c.lineTo(px - 5 * scale, py + 40 * scale); c.stroke();
            c.beginPath(); c.moveTo(px + 28 * scale, py + 30 * scale); c.lineTo(px + 35 * scale, py + 40 * scale); c.stroke();

            // Body (Gruba osoba / Kula)
            if (player.shieldLevel === 2) c.fillStyle = '#3b82f6'; // Blue for Level 2
            else if (player.shieldLevel === 1) c.fillStyle = '#10b981'; // Green for Level 1
            else c.fillStyle = '#ffdbac'; // Normal

            c.beginPath();
            c.arc(px + 15 * scale, py + 32 * scale, 16 * scale, 0, Math.PI * 2);
            c.fill();

            // Head
            c.fillStyle = '#fcd34d'; c.beginPath(); c.arc(px + 15 * scale, py + 12 * scale, 12 * scale, 0, Math.PI * 2); c.fill();
            c.fillStyle = '#92400e'; c.beginPath(); c.ellipse(px + 15 * scale, py + 5 * scale, 10 * scale, 6 * scale, 0, Math.PI, Math.PI * 2); c.fill();

            c.fillStyle = '#1f2937';
            const eyeX = (right ? 2 : -2) * scale;
            c.beginPath(); c.arc(px + 11 * scale + eyeX, py + 10 * scale, 2 * scale, 0, Math.PI * 2); c.fill();
            c.beginPath(); c.arc(px + 19 * scale + eyeX, py + 10 * scale, 2 * scale, 0, Math.PI * 2); c.fill();
            if (surprised) {
                c.beginPath(); c.ellipse(px + 15 * scale, py + 16 * scale, 3 * scale, 4 * scale, 0, 0, Math.PI * 2); c.fill();
            } else {
                c.strokeStyle = '#1f2937'; c.lineWidth = 1.5 * scale; c.beginPath(); c.arc(px + 15 * scale, py + 14 * scale, 4 * scale, 0.1 * Math.PI, 0.9 * Math.PI); c.stroke();
            }
        }

        let lastFrameTime = 0;
        const FPS_LIMIT = 60;
        const FRAME_DURATION = 1000 / FPS_LIMIT;

        function draw(timestamp) {
            if (!timestamp) timestamp = performance.now();

            const elapsed = timestamp - lastFrameTime;

            if (elapsed >= FRAME_DURATION) {
                lastFrameTime = timestamp - (elapsed % FRAME_DURATION);
                update(); // Speed now depends on FPS
                render();
            }

            requestAnimationFrame(draw);
        }

        function render() {
            ctx.save(); // Save context for shake effect i scale
            // ctx.scale(0.5, 0.5); // REMOVED: Native 800x600 resolution

            // Sober Freeze Effect (Red Shake)
            if (soberFreezeTimer > 0) {
                const shakeX = (Math.random() - 0.5) * 10;
                const shakeY = (Math.random() - 0.5) * 10;
                ctx.translate(shakeX, shakeY);

                // Red tint background override
                ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
                ctx.fillRect(-20, -20, GAME_WIDTH + 40, GAME_HEIGHT + 40);
            }

            const scheme = COLOR_SCHEMES[(level - 1) % COLOR_SCHEMES.length];

            // Use the pre-rendered background buffer
            ctx.drawImage(bgBufferCanvas, 0, 0);

            // Blinking stars effect removed as requested

            // Platforms
            platforms.forEach(p => {
                if (p.isGround) {
                    if (currentLevelPodloga && currentLevelPodloga instanceof HTMLImageElement && currentLevelPodloga.complete && currentLevelPodloga.naturalWidth !== 0) {
                        ctx.drawImage(currentLevelPodloga, p.x, p.y, p.width, p.height);
                    } else {
                        ctx.fillStyle = scheme.ground;
                        ctx.fillRect(p.x, p.y, p.width, p.height);
                    }
                } else {
                    if (currentLevelBelka && currentLevelBelka instanceof HTMLImageElement && currentLevelBelka.complete && currentLevelBelka.naturalWidth !== 0) {
                        ctx.drawImage(currentLevelBelka, p.x, p.y, p.width, p.height);
                    } else {
                        ctx.fillStyle = scheme.platforms;
                        ctx.fillRect(p.x, p.y, p.width, p.height);
                        ctx.fillStyle = scheme.accent;
                        ctx.fillRect(p.x, p.y, p.width, 4);
                    }
                }
            });

            // Coins (Kosmici)
            coins.forEach(c => {
                if (!c.collected) {
                    const bob = Math.sin(Date.now() / 350 + c.x) * 3;
                    const cx = c.x, cy = c.y + bob;
                    if (imgKosmita.complete) {
                        ctx.drawImage(imgKosmita, cx - 17, cy - 22, 45, 45);
                    } else {
                        ctx.fillStyle = '#9ca3af'; ctx.beginPath(); ctx.ellipse(cx, cy, 12, 16, 0, 0, Math.PI * 2); ctx.fill();
                        ctx.fillStyle = '#1f2937';
                        ctx.beginPath(); ctx.ellipse(cx - 5, cy - 2, 4, 6, -0.3, 0, Math.PI * 2); ctx.fill();
                        ctx.beginPath(); ctx.ellipse(cx + 5, cy - 2, 4, 6, 0.3, 0, Math.PI * 2); ctx.fill();
                    }
                }
            });

            // Effects
            effects.forEach((eff) => {
                if (eff.type === 'defeat') {
                    const progress = Math.max(0, Math.min(1, eff.timer / (eff.maxTimer || 90)));
                    const alpha = Math.sin(progress * Math.PI);
                    ctx.save();
                    ctx.globalAlpha = alpha;
                    if (imgPokonanie.complete) {
                        // Drawing centered (powr√≥t do poprzedniej pozycji)
                        ctx.drawImage(imgPokonanie, eff.x - 30, eff.y - 40, 60, 60);
                    }
                    ctx.restore();
                } else if (eff.type === 'particle') {
                    const alpha = Math.max(0, eff.timer / 20);
                    const radius = Math.max(0, 5 + (20 - eff.timer) * 0.5);
                    ctx.fillStyle = `rgba(255, 165, 0, ${alpha})`;
                    ctx.beginPath();
                    ctx.arc(eff.x, eff.y, radius, 0, Math.PI * 2);
                    ctx.fill();
                } else if (eff.type === 'cloud') {
                    const alpha = Math.max(0, eff.timer / 40);
                    const radius = Math.max(0, 8 + (40 - eff.timer) * 0.5);
                    ctx.fillStyle = 'rgba(255,255,255,0.7)';
                    ctx.beginPath();
                    ctx.arc(eff.x, eff.y, radius, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            // Enemies Update
            enemies.forEach(e => {
                // Bobbing effect ONLY for non-Karczmarz enemies
                const bob = e.type === 'karczmarz' ? 0 : Math.sin(Date.now() / 300 + e.x) * 2;

                // Shooting logic moved to update() where it belongs!

                if (imgPiwo.complete) {
                    let currentImg = imgPiwo;
                    if (e.type === 'karczmarz' || e.type === 'karczmarz_runner') {
                        if (e.isCiosany && imgCiosany.complete) currentImg = imgCiosany; // Ciosany sprite
                        else currentImg = imgKarczmarz.complete ? imgKarczmarz : imgBoss; // Standard sprite
                    } else if (level >= 2) {
                        currentImg = (e.hp === 1 && imgPiwoFaint.complete) ? imgPiwoFaint : imgPiwoStrzela;
                    } else {
                        currentImg = (e.hp === 1 && imgPiwoRed.complete) ? imgPiwoRed : imgPiwo;
                    }
                    if (currentImg.complete) {
                        ctx.drawImage(currentImg, e.x, e.y + bob, e.width, e.height);
                    }

                    // Render Speech Bubble for Runners
                    if (e.speechImg && e.speechImg.complete) {
                        const sw = 300; // Enlarged speech bubble
                        const sh = sw * (e.speechImg.height / e.speechImg.width);
                        ctx.drawImage(e.speechImg, e.x + e.width / 2 - sw / 2, e.y - sh - 10, sw, sh);
                    }
                } else {
                    let color = '#fbbf24';
                    if (e.hp === 1) color = '#ef4444';
                    ctx.fillStyle = color;
                    ctx.fillRect(e.x + 5, e.y + 10 + bob, 30, 35);
                    ctx.fillStyle = '#fefce8'; ctx.beginPath(); ctx.ellipse(e.x + 20, e.y + 12 + bob, 15, 8, 0, 0, Math.PI * 2); ctx.fill();
                }
            });

            // Bullets
            bullets.forEach(b => {
                if (b.img && b.img.complete) {
                    if (b.img === imgDetoks) {
                        ctx.drawImage(b.img, b.x, b.y, 80, 60); // Detoks - bigger
                    } else if (b.isLaser) {
                        // Laser bullet - pogrubiony, szeroki
                        ctx.drawImage(b.img, b.x, b.y - 40, 200, 80); // Laser - wide and thick
                    } else {
                        ctx.drawImage(b.img, b.x, b.y, 30, 30); // Others - small
                    }
                } else {
                    ctx.fillStyle = '#ef4444';
                    ctx.beginPath();
                    ctx.arc(b.x, b.y, b.radius || 10, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(b.x - 2, b.y - 2, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            // Player Bullets
            playerBullets.forEach(pb => {
                if (pb.isFlame && imgPlomien.complete) {
                    ctx.save();
                    if (pb.vx < 0) {
                        ctx.translate(pb.x + 40, pb.y - 15);
                        ctx.scale(-1, 1);
                        ctx.drawImage(imgPlomien, 0, 0, 40, 30);
                    } else {
                        ctx.drawImage(imgPlomien, pb.x - 40, pb.y - 15, 40, 30);
                    }
                    ctx.restore();
                } else {
                    ctx.fillStyle = '#3b82f6';
                    ctx.beginPath(); ctx.arc(pb.x, pb.y, 10, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = 'white';
                    ctx.beginPath(); ctx.arc(pb.x - 2, pb.y - 2, 4, 0, Math.PI * 2); ctx.fill();
                }
            });

            // Boss
            if (boss && !boss.isDying) {
                const bx = boss.x;
                const by = boss.y + Math.sin(Date.now() / 400) * 10;

                if (imgImieChmielus.complete) {
                    // Name graphic above boss
                    const nw = 200; // Adjust size
                    const nh = nw * (imgImieChmielus.height / imgImieChmielus.width);
                    ctx.drawImage(imgImieChmielus, bx + (boss.width - nw) / 2, by - 50, nw, nh);
                }

                if (boss.showNiePij > 0 && imgNiePij.complete) {
                    // Draw Nie Pij
                    const nw = 350;
                    const nh = nw * (imgNiePij.height / imgNiePij.width);
                    ctx.drawImage(imgNiePij, GAME_WIDTH / 2 - nw / 2, 50, nw, nh);
                }

                if (imgBossInfo.complete) {
                    // Boss info graphic on left top side under indicators
                    // Moved up 15px as requested (80 -> 65)
                    ctx.drawImage(imgBossInfo, 20, 65, 200, 100);
                }

                // BOSS Body
                ctx.save();
                if (boss.flash > 0) ctx.filter = 'brightness(2) sepia(1) saturate(100) hue-rotate(-50deg)';
                if (imgBoss.complete) {
                    ctx.drawImage(imgBoss, bx, by, boss.width, boss.height);
                } else {
                    ctx.fillStyle = '#fbbf24'; ctx.fillRect(bx + 20, by + 40, 140, 160);
                }
                ctx.restore();

                // HP Bar - moved below boss
                const barWidth = 200;
                const barHeight = 20;
                const barX = bx + (boss.width - barWidth) / 2; // Centered below boss
                const barY = by + boss.height + 10;

                ctx.fillStyle = '#333'; ctx.fillRect(barX, barY, barWidth, barHeight);
                ctx.fillStyle = '#ef4444'; ctx.fillRect(barX, barY, (boss.hp / boss.maxHp) * barWidth, barHeight);
                ctx.strokeStyle = 'white'; ctx.strokeRect(barX, barY, barWidth, barHeight);

                // Text Indicator
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`HP: ${Math.round(boss.hp)} / ${boss.maxHp}`, barX + barWidth / 2, barY + 15);
            }

            // Level Headers - Removed from draw loop to avoid duplicates
            // Headers are now managed by showGenericNotification fading element in DOM

            items.forEach(it => {
                if (!it.collected && it.type === 'shield') {
                    if (imgTarczaZielona.complete) {
                        ctx.drawImage(imgTarczaZielona, it.x - 20, it.y - 20, 60, 60);
                    } else {
                        ctx.fillStyle = '#10b981';
                        const sz = 15;
                        ctx.beginPath();
                        ctx.moveTo(it.x, it.y - sz);
                        ctx.lineTo(it.x + sz, it.y - sz / 2);
                        ctx.lineTo(it.x + sz, it.y + sz / 2);
                        ctx.quadraticCurveTo(it.x, it.y + sz * 1.5, it.x - sz, it.y + sz / 2);
                        ctx.lineTo(it.x - sz, it.y - sz / 2);
                        ctx.closePath();
                        ctx.fill();
                        ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();
                    }
                } else if (!it.collected && it.type === 'doubleShield') {
                    if (imgTarczaNiebieska.complete) {
                        ctx.drawImage(imgTarczaNiebieska, it.x - 20, it.y - 20, 60, 60);
                    } else {
                        ctx.fillStyle = '#3b82f6';
                        ctx.beginPath();
                        ctx.moveTo(it.x, it.y - sz);
                        ctx.lineTo(it.x + sz, it.y - sz / 2);
                        ctx.lineTo(it.x + sz, it.y + sz / 2);
                        ctx.quadraticCurveTo(it.x, it.y + sz * 1.5, it.x - sz, it.y + sz / 2);
                        ctx.lineTo(it.x - sz, it.y - sz / 2);
                        ctx.closePath();
                        ctx.fill();
                        ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();
                    }
                } else if (!it.collected && it.type === 'doubleShield') {
                    if (imgTarczaNiebieska.complete) {
                        ctx.drawImage(imgTarczaNiebieska, it.x - 20, it.y - 20, 40, 40);
                    } else {
                        ctx.fillStyle = '#3b82f6';
                        const sz = 15;
                        ctx.beginPath();
                        ctx.moveTo(it.x, it.y - sz);
                        ctx.lineTo(it.x + sz, it.y - sz / 2);
                        ctx.lineTo(it.x + sz, it.y + sz / 2);
                        ctx.quadraticCurveTo(it.x, it.y + sz * 1.5, it.x - sz, it.y + sz / 2);
                        ctx.lineTo(it.x - sz, it.y - sz / 2);
                        ctx.closePath();
                        ctx.fill();
                        ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();
                    }
                } else if (!it.collected && it.type === 'sober') {
                    if (imgTrzezwosc.complete) {
                        ctx.drawImage(imgTrzezwosc, it.x - 10, it.y - 60, 120, 120);
                    } else {
                        ctx.fillStyle = '#3b82f6';
                        ctx.fillRect(it.x - 20, it.y - 20, 40, 40);
                    }
                } else if (!it.collected && it.type === 'hourglass') {
                    if (imgKlepsydra.complete) {
                        // Draw hourglass
                        // Let's make it float/bob
                        const bob = Math.sin(Date.now() / 300) * 5;
                        ctx.drawImage(imgKlepsydra, it.x - 25, it.y - 35 + bob, 50, 70);
                    } else {
                        ctx.fillStyle = '#fcd34d'; // Gold
                        ctx.fillRect(it.x - 20, it.y - 30, 40, 60);
                    }
                }
            });



            // Player / Abduction
            if (abductionPhase < 4) {
                // Small downward offset when player is enlarged to keep feet on platform
                const yOffset = (player.isSober && player.height > 70) ? (player.height - 70) * -0.2 : 0;
                drawPlayer(player.x, player.y + yOffset, player.facingRight, false);
            }

            const ufoX = GAME_WIDTH / 2;
            drawUFO(ufoX);

            if (abductionPhase >= 4) {
                const pw = 45 * (player.isSober ? 1.5 : 1);
                const ufoBottomY = 80; // Wlatuje do ≈õrodka UFO (ufoY to 80)
                const liftDuration = 2500;
                const elapsed = Date.now() - playerAbductStartTime;
                const progress = Math.min(elapsed / liftDuration, 1);

                const targetX = ufoX - pw / 2;
                const currentX = playerAbductX + (targetX - playerAbductX) * progress;
                const liftY = playerAbductY - (playerAbductY - ufoBottomY) * progress;

                if (progress < 1.0) {
                    drawPlayer(currentX, liftY, true, true);
                }
            }

            // Boss Intro Overlay Effects
            // Boss Intro Overlay Effects
            if (level === 7 && introTimer < INTRO_DURATION) {
                const progress = introTimer / INTRO_DURATION;

                // Shake
                const shakeX = (Math.random() - 0.5) * 10 * (1 - progress);
                const shakeY = (Math.random() - 0.5) * 10 * (1 - progress);
                ctx.save();
                ctx.translate(shakeX, shakeY);

                // Red flashes
                if (Math.random() > 0.95) {
                    ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
                    ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                }
                ctx.restore();

                // Dark fade out
                ctx.fillStyle = `rgba(0, 0, 0, ${1 - progress})`;
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            }

            // Level 6 Intro Overlay (Dialogs)
            if (level === 6 && level6IntroStep < 5) {
                // Dim background
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

                let currentDialog = null;
                let targetX = 0;
                let targetY = 0;

                // Steps:
                // 0: Karczmarz 1
                // 1: Bohater 1
                // 2: Karczmarz 2
                // 3: Bohater 2
                // 4: Karczmarz 3

                if (level6IntroStep === 0) {
                    currentDialog = imgKarczmarz1;
                    // Find Karczmarz
                    const k = enemies.find(e => e.type === 'karczmarz');
                    if (k) { targetX = k.x + k.width / 2; targetY = k.y - 190; }
                } else if (level6IntroStep === 1) {
                    currentDialog = imgBohater1;
                    targetX = player.x + player.width / 2; targetY = player.y - 120;
                } else if (level6IntroStep === 2) {
                    currentDialog = imgKarczmarz2;
                    const k = enemies.find(e => e.type === 'karczmarz');
                    if (k) { targetX = k.x + k.width / 2; targetY = k.y - 155; }
                } else if (level6IntroStep === 3) {
                    currentDialog = imgBohater2;
                    targetX = player.x + player.width / 2; targetY = player.y - 120;
                } else if (level6IntroStep === 4) {
                    currentDialog = imgKarczmarz3;
                    const k = enemies.find(e => e.type === 'karczmarz');
                    if (k) { targetX = k.x + k.width / 2; targetY = k.y - 155; }
                }

                if (currentDialog && currentDialog.complete) {
                    // Draw centered above target with clamping
                    // ZMIANA: Rozmiar grafik dialogowych dopasowany do "Bieg" (300px)
                    const w = 500;
                    const h = 200;

                    // Clamp targetX to be within screen bounds with some padding
                    let drawX = targetX - w / 2;
                    if (drawX < 20) drawX = 20;
                    if (drawX + w > GAME_WIDTH - 20) drawX = GAME_WIDTH - w - 20;

                    // Lower position logic
                    let drawY = targetY + 30; // Lower by 30 pixels

                    ctx.drawImage(currentDialog, drawX, drawY, w, h);
                }
            }

            // Level 6 Outro Overlay
            if (level === 6 && level6OutroActive && imgKarczmarz4.complete) {
                if (level6OutroTimer === 0) { // First frame of outro just triggered
                    sfxPrzycisk.currentTime = 0; sfxPrzycisk.play().catch(() => { });
                }
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

                // Draw Karczmarz 4 dialog - larger
                // ZMIANA: Powiƒôkszenie o 50% ze 400px na 600px
                const w = 600;
                const h = w * (imgKarczmarz4.height / imgKarczmarz4.width);
                const k = enemies.find(e => e.type === 'karczmarz');
                let tx = GAME_WIDTH / 2; let ty = GAME_HEIGHT / 2;
                if (k) { tx = k.x + k.width / 2; ty = k.y - 120; }

                ctx.drawImage(imgKarczmarz4, (GAME_WIDTH - w) / 2, GAME_HEIGHT / 2 - h / 2 - 50, w, h);

                // Draw Fade Overlay
                if (level6OutroFade > 0) {
                    ctx.fillStyle = `rgba(0, 0, 0, ${level6OutroFade})`;
                    ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                }
            }

            // Update previous jump state for rising edge detection
            player.prevJumpState = keys.jump;

            ctx.restore(); // Restore scale and shake
        }

        function drawPlayer(px, py, right, surprised) {
            drawPlayerOnCtx(ctx, px, py, right, surprised);
        }

        function drawUFO(ufoX) {
            const scheme = COLOR_SCHEMES[(level - 1) % COLOR_SCHEMES.length];
            const ufoY = abductionPhase >= 1 ? 80 : -150;
            ctx.save();
            ctx.translate(ufoX, ufoY);

            if (abductionPhase >= 3) {
                ctx.fillStyle = scheme.accent; ctx.globalAlpha = 0.2 + Math.sin(Date.now() / 200) * 0.1;
                ctx.beginPath();
                ctx.moveTo(-40, 40);
                ctx.lineTo(40, 40);
                ctx.lineTo(120, 500);
                ctx.lineTo(-120, 500);
                ctx.fill();
                ctx.globalAlpha = 1;
            }

            if (imgUfo.complete) {
                // Centering ufo.png (assuming it should be around the same size as the old drawn UFO)
                ctx.drawImage(imgUfo, -75, -25, 150, 75);
            } else {
                ctx.fillStyle = "#4b5563"; ctx.beginPath(); ctx.ellipse(0, 10, 70, 22, 0, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = "#6b7280"; ctx.beginPath(); ctx.ellipse(0, 0, 50, 30, 0, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = "#60a5fa"; ctx.globalAlpha = 0.6; ctx.beginPath(); ctx.ellipse(0, -15, 22, 20, 0, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1;
            }

            if (level === 7 && abductionPhase >= 4) {
                // Aliens removed as requested
            }

            ctx.restore();
        }

        function spawnHourglass() {
            // Random location: X [50, 750], Y [150, 500]
            const x = 50 + Math.random() * (GAME_WIDTH - 100);
            const y = 150 + Math.random() * (GAME_HEIGHT - 250);
            items.push({ x: x, y: y, type: 'hourglass', collected: false });
        }

        setupControls();
        generateLevel(1);

        // Initial draw or loading state
        if (!assets.isReady) {
            checkAssetsLoaded();
        }

        draw();
    </script>
</body>

</html>